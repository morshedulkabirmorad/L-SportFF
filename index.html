<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=no">
    <title>Gaming Tournament</title>

    <!-- Icons and Fonts -->
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.11.3/font/bootstrap-icons.min.css">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css">
    <link href="https://fonts.googleapis.com/css2?family=Poppins:wght@400;500;600;700&display=swap" rel="stylesheet">
    <!-- Swiper CSS -->
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/swiper@11/swiper-bundle.min.css" />
    <!-- Bootstrap CSS -->
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet">

    <style>
        /* --- CSS Styles --- */
        :root {
            --primary-bg: #0F172A;
            --secondary-bg: #1E293B;
            --card-bg: #1E293B;
            --text-primary: #E2E8F0;
            --text-secondary: #94A3B8;
            --accent-color: #FACC15;
            --accent-gradient: linear-gradient(to right, #FACC15, #FBBF24);
            --primary-button-bg: #3B82F6;
            --border-color: #334155;
            --bottom-nav-bg: #1E293B;
            --success-color: #10B981;
            --danger-color: #EF4444;
            --warning-color: #F59E0B;
            --info-color: #3B82F6;
        }
        * { margin: 0; padding: 0; box-sizing: border-box; }
        html { font-size: 16px; }
        body { font-family: 'Poppins', sans-serif; background-color: var(--primary-bg); color: var(--text-primary); padding-top: 70px; padding-bottom: 75px; min-height: 100vh; overscroll-behavior-y: contain; }
        a { color: var(--accent-color); text-decoration: none; } a:hover { color: #FBBF24; }
        .main-content { padding: 15px; } .section { display: none; animation: fadeIn 0.3s ease-in-out; } .section.active { display: block; } @keyframes fadeIn { from { opacity: 0; transform: translateY(10px); } to { opacity: 1; transform: translateY(0); } }
        .section-title { font-size: 1.1rem; font-weight: 600; margin-bottom: 15px; color: var(--text-primary); } .custom-card { background-color: var(--card-bg); border-radius: 10px; padding: 15px; margin-bottom: 15px; box-shadow: 0 1px 3px rgba(0, 0, 0, 0.1); border: 1px solid var(--border-color); } .btn-custom { border-radius: 6px; font-size: 0.9rem; font-weight: 500; padding: 8px 15px; border: none; display: inline-flex; align-items: center; justify-content: center; gap: 5px; transition: background-color 0.2s ease, filter 0.2s ease; } .btn-custom-primary { background-color: var(--primary-button-bg); color: var(--text-primary); } .btn-custom-primary:hover { background-color: #2563EB; } .btn-custom-secondary { background-color: var(--secondary-bg); color: var(--text-primary); border: 1px solid var(--border-color); } .btn-custom-secondary:hover { background-color: #334155; } .btn-custom-accent { background: var(--accent-gradient); color: var(--primary-bg); font-weight: 600; } .btn-custom-accent:hover { filter: brightness(1.1); } .btn-custom-link { background: none; border: none; color: var(--primary-button-bg); font-size: 0.9rem; font-weight: 500; padding: 0; cursor: pointer; } .text-accent { color: var(--accent-color); } .text-success { color: var(--success-color); } .text-danger { color: var(--danger-color); } .text-warning { color: var(--warning-color); } .form-control { background-color: var(--primary-bg); border: 1px solid var(--border-color); color: var(--text-primary); border-radius: 6px; } .form-control:focus { background-color: var(--primary-bg); border-color: var(--accent-color); color: var(--text-primary); box-shadow: 0 0 0 0.2rem rgba(250, 204, 21, 0.25); } .form-control::placeholder { color: var(--text-secondary); opacity: 0.7; } .form-label { color: var(--text-secondary); font-size: 0.9rem; } .alert { border-radius: 6px; font-size: 0.9rem; } .list-group-item { background-color: var(--card-bg); color: var(--text-primary); border: none; border-bottom: 1px solid var(--border-color); padding: 15px; font-size: 0.95rem; transition: background-color 0.2s ease; } .list-group-item:hover { background-color: rgba(255, 255, 255, 0.05); } .list-group-item:last-child { border-bottom: none; } .list-group-item i:first-child { color: var(--accent-color); margin-right: 15px; font-size: 1.1rem; width: 20px; text-align: center; } .list-group-item .bi-chevron-right, .list-group-item .bi-box-arrow-up-right { color: var(--text-secondary); font-size: 0.9rem; } #globalLoaderEl { position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0, 0, 0, 0.6); display: flex; justify-content: center; align-items: center; z-index: 9999; display: none; } .spinner-border { color: var(--accent-color); width: 3rem; height: 3rem; } .placeholder-glow .placeholder { background-color: rgba(51, 65, 85, 0.5); animation: placeholder-glow 2s ease-in-out infinite; } .placeholder { background-color: rgba(51, 65, 85, 0.5); border-radius: 4px; } @keyframes placeholder-glow { 0% { background-color: rgba(51, 65, 85, 0.5); } 50% { background-color: rgba(51, 65, 85, 0.7); } 100% { background-color: rgba(51, 65, 85, 0.5); } } .interactive-list-item { cursor: pointer; } .referral-code { font-family: monospace; letter-spacing: 1px; user-select: all; } .app-header { position: fixed; top: 0; left: 0; width: 100%; height: 60px; background-color: var(--secondary-bg); display: flex; align-items: center; justify-content: space-between; padding: 0 15px; box-shadow: 0 2px 5px rgba(0, 0, 0, 0.2); z-index: 1000; border-bottom: 1px solid var(--border-color); } .header-left { display: flex; align-items: center; gap: 10px; } .header-logo { width: 40px; height: 40px; border-radius: 50%; background-color: #fff; object-fit: cover; border: 1px solid var(--accent-color); } .header-title { font-size: 0.9rem; font-weight: 500; line-height: 1.2; } .header-title span { font-size: 0.75rem; color: var(--text-secondary); display: block; } .header-back-button { background: none; border: none; color: var(--text-primary); font-size: 1.4rem; margin-right: 5px; display: none; padding: 5px; } .header-right { display: flex; align-items: center; gap: 15px; } .notification-icon { font-size: 1.3rem; color: var(--text-primary); position: relative; background: none; border: none; padding: 0; } .notification-badge { position: absolute; top: -3px; right: -5px; background-color: var(--danger-color); color: white; font-size: 0.6rem; width: 15px; height: 15px; border-radius: 50%; display: flex; justify-content: center; align-items: center; font-weight: bold; } .wallet-chip { background: var(--accent-gradient); color: var(--primary-bg); padding: 5px 12px; border-radius: 20px; display: flex; align-items: center; font-size: 0.85rem; font-weight: 700; border: none; box-shadow: 0 1px 3px rgba(0, 0, 0, 0.2); cursor: pointer; } .wallet-chip i { margin-right: 5px; font-size: 0.9rem; } .header-game-title { font-size: 1rem; font-weight: 600; color: var(--text-primary); margin-left: 10px; display: none; } .bottom-nav { position: fixed; bottom: 0; left: 0; width: 100%; height: 65px; background-color: var(--bottom-nav-bg); display: flex; justify-content: space-around; align-items: stretch; box-shadow: 0 -2px 5px rgba(0, 0, 0, 0.2); z-index: 1000; border-top: 1px solid var(--border-color); } .nav-item { display: flex; flex-direction: column; align-items: center; justify-content: center; color: var(--text-secondary); text-decoration: none; flex-grow: 1; padding: 8px 0; transition: color 0.2s ease, background-color 0.2s ease; border: none; background: none; cursor: pointer; font-size: 0.7rem; } .nav-item i { font-size: 1.4rem; margin-bottom: 4px; line-height: 1; } .nav-item span { font-size: 0.7rem; font-weight: 500; line-height: 1; } .nav-item.active { color: var(--accent-color); background-color: rgba(250, 204, 21, 0.1); } .swiper-container#promotionSliderEl { width: 100%; height: 200px; border-radius: 10px; margin-bottom: 25px; --swiper-pagination-color: var(--accent-color); --swiper-pagination-bullet-inactive-color: var(--text-secondary); --swiper-pagination-bullet-size: 8px; } .swiper-slide { background-color: var(--secondary-bg); border-radius: 10px; } .swiper-slide img { display: block; width: 100%; height: 100%; object-fit: cover; border-radius: 10px; } .game-card { text-align: center; background-color: var(--card-bg); border-radius: 8px; overflow: hidden; padding: 0; border: 1px solid var(--border-color); cursor: pointer; transition: transform 0.2s ease; } .game-card:hover { transform: translateY(-3px); box-shadow: 0 4px 8px rgba(0,0,0,0.2); } .game-card img { width: 100%; height: 130px; object-fit: cover; display: block; } .game-card span { display: block; padding: 10px 5px; font-weight: 500; font-size: 0.9rem; color: var(--text-primary); } .tournament-tabs { display: flex; justify-content: space-around; background-color: var(--secondary-bg); padding: 5px; border-radius: 8px; margin-bottom: 15px; } .tab-item { color: var(--text-secondary); background: none; border: none; padding: 8px 10px; font-size: 0.85rem; font-weight: 600; border-radius: 6px; flex-grow: 1; text-align: center; cursor: pointer; transition: background-color 0.2s, color 0.2s; } .tab-item.active { background-color: var(--primary-button-bg); color: var(--text-primary); } .tab-item i { margin-right: 5px; } .tournament-card { background-color: var(--card-bg); border-radius: 12px; margin-bottom: 15px; padding: 15px; border: 1px solid var(--border-color); overflow: hidden; } .tournament-card-header { display: flex; justify-content: space-between; align-items: center; margin-bottom: 10px; flex-wrap: wrap; gap: 5px; } .tournament-card-tags span { background-color: var(--primary-bg); color: var(--text-secondary); font-size: 0.7rem; font-weight: 500; padding: 3px 8px; border-radius: 4px; display: inline-block; border: 1px solid var(--border-color); margin-right: 4px; margin-bottom: 4px; } .tournament-card-timer { background-color: rgba(255, 255, 255, 0.1); color: var(--text-primary); font-size: 0.75rem; font-weight: 600; padding: 3px 8px; border-radius: 4px; } .tournament-card-title { font-size: 1rem; font-weight: 600; margin-bottom: 5px; display: flex; align-items: center; gap: 8px; color: var(--text-primary); } .tournament-card-title i { color: var(--accent-color); } .tournament-card-info { display: flex; justify-content: space-between; align-items: stretch; border-top: 1px dashed var(--border-color); border-bottom: 1px dashed var(--border-color); padding: 10px 0; margin: 10px 0; font-size: 0.8rem; } .info-item { text-align: center; flex: 1; padding: 0 5px; } .info-item span { display: block; color: var(--text-secondary); font-size: 0.7rem; margin-bottom: 2px; } .info-item strong { color: var(--text-primary); font-weight: 600; font-size: 0.9rem; } .info-item .prize-icon { color: var(--accent-color); font-size: 1.2rem; } .tournament-card-spots { font-size: 0.8rem; color: var(--text-secondary); margin-bottom: 15px; } .tournament-card-spots span { font-weight: 600; } .progress { height: 6px; background-color: var(--primary-bg); border-radius: 3px; overflow: hidden; } .progress-bar { background-color: var(--warning-color); transition: width 0.3s ease; } .tournament-card-actions { display: grid; grid-template-columns: 1fr 1fr; gap: 10px; margin-top: 10px; } .tournament-card-actions .btn-sm { padding: 8px 10px; font-size: 0.85rem; width: 100%; } .tournament-card-actions .btn-join { background: var(--accent-gradient); color: var(--primary-bg); font-weight: 600; grid-column: 2 / 3; } .tournament-card-actions .btn-details { background-color: var(--secondary-bg); border: 1px solid var(--border-color); grid-column: 1 / 2; } .tournament-card-actions .btn-joined { background-color: var(--success-color); color: var(--text-primary); opacity: 0.8; grid-column: 2 / 3; } .tournament-card-actions .btn-disabled { background-color: var(--secondary-bg); opacity: 0.6; cursor: not-allowed; grid-column: 2 / 3; } .btn-idpass { background: var(--accent-gradient); color: var(--primary-bg); border: none; font-weight: 600; } .wallet-card { background: linear-gradient(145deg, var(--secondary-bg), var(--primary-bg)); border-radius: 10px; padding: 20px; border: 1px solid var(--border-color); } .wallet-card h2 { font-size: 1.2rem; font-weight: 600; margin-bottom: 25px; } .balance-item { display: flex; justify-content: space-between; align-items: center; margin-bottom: 20px; padding-bottom: 15px; border-bottom: 1px dashed var(--border-color); } .balance-item:last-child { margin-bottom: 0; border-bottom: none; padding-bottom: 0; } .balance-item-label { font-size: 0.95rem; color: var(--text-secondary); } .balance-item-value { font-size: 1.1rem; font-weight: 600; } .balance-item-action { min-width: 100px; text-align: right; } .balance-item-action .btn-custom-link { font-size: 0.85rem; color: var(--accent-color); padding: 5px; } .balance-item-action .btn-withdraw { background-color: var(--primary-button-bg); color: #fff; font-size: 0.8rem; padding: 5px 12px; border-radius: 5px; border: none; } #recentTransactionsListEl .custom-card { background-color: var(--secondary-bg); }
        .profile-header-card { background: linear-gradient(145deg, var(--secondary-bg), var(--primary-bg)); border-radius: 10px; padding: 20px; display: flex; flex-direction: column; align-items: center; text-align: center; margin-bottom: 20px; border: 1px solid var(--border-color); } .profile-avatar { width: 70px; height: 70px; border-radius: 50%; margin-bottom: 10px; border: 2px solid var(--accent-color); object-fit: cover; background-color: var(--primary-bg); } .profile-name { font-size: 1.1rem; font-weight: 600; } .profile-email { font-size: 0.85rem; color: var(--text-secondary); margin-bottom: 15px; word-break: break-all; } .profile-stats { display: flex; justify-content: space-around; width: 100%; border-top: 1px solid var(--border-color); padding-top: 15px; } .stat-item { text-align: center; flex: 1; } .stat-item strong { display: block; font-size: 1rem; font-weight: 600; } .stat-item span { font-size: 0.75rem; color: var(--text-secondary); } .profile-links .list-group { border-radius: 10px; overflow: hidden; border: 1px solid var(--border-color); } .profile-links .form-switch .form-check-input { background-color: var(--secondary-bg); border-color: var(--border-color); background-image: url("data:image/svg+xml,%3csvg xmlns='http://www.w3.org/2000/svg' viewBox='-4 -4 8 8'%3e%3ccircle r='3' fill='rgba%28255, 255, 255, 0.25%29'/%3e%3c/svg%3e"); } .profile-links .form-switch .form-check-input:checked { background-color: var(--accent-color); border-color: var(--accent-color); background-image: url("data:image/svg+xml,%3csvg xmlns='http://www.w3.org/2000/svg' viewBox='-4 -4 8 8'%3e%3ccircle r='3' fill='%23fff'/%3e%3c/svg%3e"); } #login-section { margin-top: 5vh; } #login-section .card { background-color: var(--card-bg); border: 1px solid var(--border-color); } #login-section .btn-primary { background-color: var(--primary-button-bg); border: none; } #login-section .btn-link { background: none; border: none; color: var(--accent-color); text-decoration: none; font-size: 0.9em; padding: 5px 0; } #login-section .btn-link:hover { text-decoration: underline; } #login-section .btn-success { background-color: var(--success-color); border: none; } #login-section .btn-danger { background-color: var(--danger-color); border: none; } #login-section .form-divider { text-align: center; margin: 20px 0; position: relative; color: var(--text-secondary); } #login-section .form-divider::before, #login-section .form-divider::after { content: ""; position: absolute; top: 50%; width: 40%; height: 1px; background-color: var(--border-color); } #login-section .form-divider::before { left: 0; } #login-section .form-divider::after { right: 0; } #login-section .form-divider span { background-color: var(--card-bg); padding: 0 10px; position: relative; z-index: 1; font-size: 0.8rem; font-weight: 500; } #login-section .card-title { color: var(--text-primary); } #googleSignInBtnMainEl { display: none; } .modal-content { background-color: var(--secondary-bg); color: var(--text-primary); border: 1px solid var(--border-color); } .modal-header { border-bottom-color: var(--border-color); } .modal-footer { border-top-color: var(--border-color); } .btn-close-white { filter: invert(1) grayscale(100%) brightness(200%); } .modal-body .phonepe-number { color: var(--warning-color); font-weight: bold; user-select: text; } #matchDetailsModalBodyEl pre { background-color: var(--primary-bg); padding: 10px; border-radius: 5px; border: 1px solid var(--border-color); color: var(--text-secondary); font-size: 0.85rem; white-space: pre-wrap; word-wrap: break-word; } #policyModalBodyEl { line-height: 1.6; font-size: 0.95rem; white-space: pre-wrap; } #idPasswordModalEl .copy-btn { padding: 2px 6px; font-size: 0.8rem; margin-left: 8px; vertical-align: middle; } #policyModalBodyEl .copy-btn, #policyModalBodyEl #shareReferralBtn { padding: 4px 10px; font-size: 0.9rem; } #policyModalBodyEl #shareReferralBtn i, #policyModalBodyEl .copy-btn i { margin-right: 5px; } #securityWarning { background-color: var(--danger-color); color: white; padding: 10px 15px; text-align: center; font-size: 0.9rem; position: sticky; top: 60px; z-index: 999; border-bottom: 1px solid #a51d1d; } #securityWarning a { color: #ffdddd; text-decoration: underline; } #securityWarning button { background: none; border: 1px solid white; color: white; padding: 2px 8px; margin-left: 15px; font-size: 0.8rem; border-radius: 4px; cursor: pointer; }
        .payment-method-list .list-group-item { padding: 1rem; cursor: pointer; border: 1px solid var(--border-color); border-radius: 8px; margin-bottom: 10px; background-color: var(--primary-bg); transition: border-color 0.2s ease, background-color 0.2s ease; } .payment-method-list .list-group-item:has(input:checked) { background-color: var(--secondary-bg); border-color: var(--accent-color); box-shadow: 0 0 0 2px rgba(250, 204, 21, 0.3); } .payment-method-list .form-check-input { width: 1.2em; height: 1.2em; } .payment-method-list .form-check-input:checked { background-color: var(--accent-color); border-color: var(--accent-color); }
        @keyframes logo-animation { from { transform: scale(0.9); opacity: 0.7; } to { transform: scale(1); opacity: 1; } } @keyframes blink-animation { 0%, 100% { opacity: 1; } 50% { opacity: 0.5; } }
        .login-logo { width: 80px; height: 80px; border-radius: 50%; margin-bottom: 15px; border: 2px solid var(--accent-color); animation: logo-animation 1.5s ease-in-out infinite alternate; }
        .login-brand-title { font-size: 1.5rem; font-weight: 700; color: var(--text-primary); letter-spacing: 2px; text-shadow: 0 0 5px rgba(250, 204, 21, 0.3); animation: blink-animation 2.5s linear infinite; }
        .leaderboard-list { list-style: none; padding: 0; }
        .leaderboard-item { display: flex; align-items: center; padding: 10px; background-color: var(--secondary-bg); border-radius: 8px; margin-bottom: 10px; border: 1px solid var(--border-color); }
        .leaderboard-item:nth-child(1) .leaderboard-rank { color: #FFD700; font-size: 1.5rem; } 
        .leaderboard-item:nth-child(2) .leaderboard-rank { color: #C0C0C0; font-size: 1.4rem; } 
        .leaderboard-item:nth-child(3) .leaderboard-rank { color: #CD7F32; font-size: 1.3rem; } 
        .leaderboard-rank { font-size: 1.2rem; font-weight: 700; color: var(--text-primary); width: 40px; text-align: center; flex-shrink: 0; }
        .leaderboard-avatar { width: 45px; height: 45px; border-radius: 50%; margin: 0 15px; object-fit: cover; border: 2px solid var(--border-color); }
        .leaderboard-name { font-weight: 500; color: var(--text-primary); flex-grow: 1; overflow: hidden; text-overflow: ellipsis; white-space: nowrap; }
        .leaderboard-winnings { font-weight: 600; color: var(--success-color); font-size: 1rem; }
        .update-post-card { background-color: var(--card-bg); border-radius: 10px; margin-bottom: 20px; border: 1px solid var(--border-color); overflow: hidden; }
        .update-post-image { width: 100%; max-height: 400px; object-fit: cover; display: block; }
        .update-post-content { padding: 15px; }
        .update-post-title { font-size: 1.1rem; font-weight: 600; margin-bottom: 10px; color: var(--text-primary); }
        .update-post-body { font-size: 0.9rem; color: var(--text-secondary); line-height: 1.6; }
        .update-post-actions { padding: 10px 15px; border-top: 1px solid var(--border-color); display: flex; align-items: center; gap: 20px; }
        .action-btn { background: none; border: none; color: var(--text-secondary); display: flex; align-items: center; gap: 8px; font-size: 0.9rem; font-weight: 500; cursor: pointer; transition: color 0.2s ease; }
        .action-btn:hover { color: var(--accent-color); }
        .action-btn.loved i { color: var(--danger-color); }
        .action-btn i { font-size: 1.2rem; }
        .chat-messages, .comment-list { max-height: 40vh; overflow-y: auto; padding: 10px; background-color: var(--primary-bg); border-radius: 8px; margin-bottom: 15px; }
        .chat-message, .comment-item { display: flex; margin-bottom: 10px; max-width: 85%; }
        .chat-message.user { margin-left: auto; flex-direction: row-reverse; }
        .chat-message.admin .chat-bubble { background-color: var(--secondary-bg); }
        .chat-message.user .chat-bubble { background-color: var(--primary-button-bg); color: var(--text-primary); }
        .chat-bubble { padding: 8px 12px; border-radius: 15px; font-size: 0.9rem; word-break: break-word; }
        .chat-bubble-meta, .comment-meta { font-size: 0.7rem; color: var(--text-secondary); margin-top: 4px; }
        .chat-message.user .chat-bubble-meta { text-align: right; }
        .comment-item { flex-direction: column; background-color: var(--secondary-bg); padding: 10px; border-radius: 8px; border: 1px solid var(--border-color); }
        .comment-meta { display: flex; justify-content: space-between; align-items: center; }
        .comment-meta strong { color: var(--accent-color); font-weight: 500;}
        .comment-body { margin-top: 5px; font-size: 0.9rem; }
        .message-input-group { display: flex; gap: 10px; }
        .message-input-group input { flex-grow: 1; }
        .loader{width:20px;aspect-ratio:1;border-radius:50%;background:var(--accent-color);box-shadow:0 0 0 0 rgba(250, 204, 21, 0.25);animation:l2 1.5s infinite linear;position:relative}.loader:before,.loader:after{content:"";position:absolute;inset:0;border-radius:inherit;box-shadow:0 0 0 0 rgba(250, 204, 21, 0.25);animation:inherit;animation-delay:-.5s}.loader:after{animation-delay:-1s}@keyframes l2{100%{box-shadow:0 0 0 40px #0000}}

        /* --- HOME PAGE TABS & USER SCROLL --- */
        .home-tabs-container { display: flex; gap: 10px; justify-content: space-between; margin-bottom: 20px; }
        .home-tab-box { background: var(--card-bg); border: 1px solid var(--border-color); color: var(--text-primary); padding: 15px 5px; border-radius: 8px; text-align: center; flex: 1; font-weight: 600; font-size: 0.9rem; cursor: pointer; transition: 0.2s; box-shadow: 0 2px 4px rgba(0,0,0,0.2); display: flex; flex-direction: column; align-items: center; justify-content: center; gap: 5px; }
        .home-tab-box:hover { border-color: var(--accent-color); }
        .home-tab-box:active { transform: scale(0.95); background: var(--secondary-bg); }
        .home-tab-box i { font-size: 1.2rem; color: var(--accent-color); }

        .user-ticker-container { overflow-x: auto; white-space: nowrap; padding-bottom: 10px; -webkit-overflow-scrolling: touch; margin-bottom: 20px; }
        .user-ticker-wrapper { display: inline-flex; gap: 15px; padding: 0 5px; }
        .ticker-item { text-align: center; width: 60px; display: inline-block; vertical-align: top; }
        .ticker-avatar { width: 50px; height: 50px; border-radius: 50%; border: 2px solid var(--accent-color); object-fit: cover; display: block; margin: 0 auto 5px; background-color: var(--card-bg); }
        .ticker-name { font-size: 0.7rem; color: var(--text-secondary); display: block; overflow: hidden; text-overflow: ellipsis; width: 100%; }
        .user-ticker-container::-webkit-scrollbar { display: none; }
        
        /* --- OLD & NEW STYLES FROM REQUEST --- */
        /* Marquee Text */
        @keyframes marquee-scroll-with-pause { 0% { transform: translateX(100%); } 85% { transform: translateX(-110%); } 100% { transform: translateX(-110%); } }
        .marquee-container { background-color: var(--secondary-bg); padding: 8px 0; overflow: hidden; white-space: nowrap; border-radius: 6px; margin-bottom: 20px; border: 1px solid var(--border-color); display: none; }
        .marquee-text-wrapper { display: inline-block; color: var(--text-primary); font-weight: 500; font-size: 0.9rem; padding-left: 100%; animation: marquee-scroll-with-pause 18s linear infinite; }
        .marquee-text-wrapper:hover { animation-play-state: paused; }
        /* Time Dashboard */
        .time-dashboard { background: var(--card-bg); border: 1px solid var(--border-color); border-radius: 8px; padding: 10px 15px; margin-top: -10px; margin-bottom: 20px; display: flex; justify-content: space-between; align-items: center; text-align: center; font-size: 0.85rem; font-weight: 500; }
        .time-dashboard-item { flex: 1; color: var(--text-secondary); }
        .time-dashboard-item strong { display: block; color: var(--text-primary); font-size: 0.95rem; }
        .time-dashboard-item:not(:last-child) { border-right: 1px solid var(--border-color); }
        /* Home Banner */
        .home-banner-container { margin-bottom: 20px; display: none; /* Hidden by default */ }
        .home-banner-container a { display: block; }
        .home-banner-container img { width: 100%; border-radius: 10px; object-fit: cover; border: 1px solid var(--border-color); aspect-ratio: 16 / 9; }
        
        /* --- NEW STYLES FROM LATEST REQUEST --- */
        /* Features Dashboard (Subscription & Promo Code) */
        .features-dashboard { display: flex; gap: 15px; justify-content: space-around; margin-bottom: 20px; }
        .feature-box { background: var(--card-bg); border: 1px solid var(--border-color); color: var(--text-primary); padding: 15px 10px; border-radius: 8px; text-align: center; flex: 1; font-weight: 600; font-size: 0.9rem; cursor: pointer; transition: all 0.2s ease; box-shadow: 0 2px 4px rgba(0,0,0,0.2); display: flex; flex-direction: column; align-items: center; justify-content: center; gap: 8px; }
        .feature-box:hover { border-color: var(--accent-color); transform: translateY(-2px); }
        .feature-box:active { transform: scale(0.95); background: var(--secondary-bg); }
        .feature-box i { font-size: 1.5rem; color: var(--accent-color); }
        /* Social Icons inside Modal */
        .social-icons-modal-wrapper { display: flex; flex-wrap: wrap; gap: 20px; justify-content: center; padding-top: 15px; }
        .social-icon { display: flex; align-items: center; justify-content: center; width: 50px; height: 50px; border-radius: 50%; background-color: var(--secondary-bg); border: 1px solid var(--border-color); color: var(--text-primary); font-size: 1.5rem; transition: background-color 0.2s, color 0.2s; text-decoration: none; }
        .social-icon:hover { background-color: var(--accent-color); color: var(--primary-bg); }

    </style>
</head>

<body>
     <!-- Firebase Security Rules Warning -->
    <div id="securityWarning" style="display: none;">
        <i class="bi bi-exclamation-triangle-fill"></i> <strong>Security Alert:</strong> Your database rules are insecure (public). Anyone can read/write data.
        <a href="https://firebase.google.com/docs/database/security" target="_blank" rel="noopener noreferrer">Learn how to secure rules.</a>
        <button onclick="this.parentElement.style.display='none'">Dismiss</button>
    </div>

    <!-- Header -->
    <header class="app-header">
        <div class="header-left">
            <button class="header-back-button" id="headerBackBtnEl"><i class="bi bi-arrow-left"></i></button>
            <img src="https://via.placeholder.com/40/FFFFFF/0F172A?text=G" alt="Logo" class="header-logo" id="appLogoEl">
            <div class="header-title" id="headerTitleContainerEl"> Welcome <span id="headerUserGreetingEl">Guest</span> </div>
            <div class="header-game-title" id="headerGameTitleEl">Game Title</div>
        </div>
        <div class="header-right">
            <button class="notification-icon" id="notificationBtnEl"> <i class="bi bi-bell-fill"></i> <span class="notification-badge" style="display: none;"></span> </button>
            <button class="wallet-chip" id="headerWalletChipEl" style="display: none;"> <i class="bi bi-wallet-fill"></i> à§³<span id="headerChipBalanceEl">0</span> </button>
        </div>
    </header>

    <!-- Main Content Area -->
    <main class="main-content">
        <div id="globalLoaderEl"> <div class="loader"></div> </div>

        <!-- Login Section -->
        <section id="login-section" class="section">
             <div class="container" style="max-width: 450px;">
                <div class="text-center mb-4 login-logo-container">
                    <img src="https://via.placeholder.com/80/FFFFFF/0F172A?text=G" alt="Logo" class="login-logo" id="loginLogoEl">
                    <h1 class="login-brand-title">L TOURNAMENT</h1>
                </div>

                <div class="card shadow-sm custom-card">
                    <div class="card-body p-4">
                        <!-- Login Form -->
                        <form id="emailLoginForm">
                            <h2 class="card-title text-center mb-4">Login</h2>
                            <div class="mb-3"> <label for="loginEmailInputEl" class="form-label">Email</label> <input type="email" class="form-control" id="loginEmailInputEl" placeholder="name@example.com" required> </div>
                            <div class="mb-3"> <label for="loginPasswordInputEl" class="form-label">Password</label> <input type="password" class="form-control" id="loginPasswordInputEl" placeholder="Password" required> </div>
                            <div id="loginStatusMessageEl" class="alert mt-3" style="display: none;"></div>
                            <div class="d-grid gap-2 mb-3"> <button type="button" class="btn btn-custom btn-custom-primary" id="loginEmailBtnEl">Login</button> <button type="button" class="btn-custom-link btn-sm p-0 text-center d-block" id="showSignupToggleBtnEl">Need an account? Sign Up</button> <a href="#" id="forgotPasswordLinkEl" class="text-center small mt-2 d-block" style="color: var(--text-secondary);">Forgot Password?</a> </div>
                        </form>

                        <!-- Signup Form (Initially Hidden) -->
                        <form id="emailSignupForm" style="display: none;">
                            <h2 class="card-title text-center mb-4">Sign Up</h2>
                            <div class="mb-3"> <label for="signupEmailInputEl" class="form-label">Email</label> <input type="email" class="form-control" id="signupEmailInputEl" placeholder="name@example.com" required> </div>
                            <div class="mb-3"> <label for="signupPasswordInputEl" class="form-label">Password (min 6 chars)</label> <input type="password" class="form-control" id="signupPasswordInputEl" placeholder="Password" required minlength="6"> </div>
                            <div class="mb-3"> <label for="signupConfirmPasswordInputEl" class="form-label">Confirm Password</label> <input type="password" class="form-control" id="signupConfirmPasswordInputEl" placeholder="Confirm Password" required> </div>
                            <div class="mb-3"> <label for="signupReferralCodeInputEl" class="form-label">Referral Code (Optional)</label> <input type="text" class="form-control" id="signupReferralCodeInputEl" placeholder="Enter referral code"> </div>
                            <div id="signupStatusMessageEl" class="alert mt-3" style="display: none;"></div>
                            <div class="d-grid gap-2 mb-3"> <button type="button" class="btn btn-custom btn-custom-accent" id="signupEmailBtnEl">Sign Up</button> <button type="button" class="btn-custom-link btn-sm p-0 text-center d-block" id="showLoginToggleBtnEl">Already have account? Login</button> </div>
                        </form>
                    </div>
                </div>
            </div>
        </section>

        <!-- Home Section -->
        <section id="home-section" class="section">
            <!-- 1. Marquee Text -->
            <div class="marquee-container" id="marqueeContainerEl">
                <p class="marquee-text-wrapper" id="marqueeTextEl">Loading notice...</p>
            </div>

            <!-- 2. Promotion Slider -->
            <div class="swiper-container" id="promotionSliderEl">
                <div class="swiper-wrapper placeholder-glow"> <div class="swiper-slide"><span class="placeholder" style="display: block; width: 100%; height: 100%; border-radius: 10px;"></span></div> </div>
                 <div class="swiper-pagination"></div>
            </div>

            <!-- 3. Time Dashboard -->
            <div class="time-dashboard" id="timeDashboardEl">
                <div class="time-dashboard-item">Time <strong id="timeDashboardTimeEl">--:--:--</strong></div>
                <div class="time-dashboard-item">Date <strong id="timeDashboardDateEl">--/--/----</strong></div>
                <div class="time-dashboard-item">Day <strong id="timeDashboardDayEl">---</strong></div>
            </div>

            <!-- 4. NEW: Features Dashboard -->
            <div class="features-dashboard" id="featuresDashboardEl">
                <div class="feature-box" data-bs-toggle="modal" data-bs-target="#socialMediaModalEl">
                    <i class="bi bi-person-heart"></i>
                    <span>Subscription</span>
                </div>
                <div class="feature-box" data-bs-toggle="modal" data-bs-target="#promoCodeModalEl">
                    <i class="bi bi-gift-fill"></i>
                    <span>Promo Code</span>
                </div>
            </div>

            <!-- 5. NEW: Banner Image -->
            <div class="home-banner-container" id="homeBannerContainerEl">
                <!-- Banner will be injected here by JS -->
            </div>

            <!-- 6. Home Page Tournament Filter Tabs -->
            <div class="home-tabs-container">
                <div class="home-tab-box" data-target="upcoming">
                    <i class="bi bi-calendar-event-fill"></i>
                    <span>Upcoming</span>
                </div>
                <div class="home-tab-box" data-target="ongoing">
                    <i class="bi bi-play-circle-fill"></i>
                    <span>Ongoing</span>
                </div>
                <div class="home-tab-box" data-target="completed">
                    <i class="bi bi-trophy-fill"></i>
                    <span>Results</span>
                </div>
            </div>

            <!-- 7. User Profiles Horizontal Scroll -->
            <h6 class="text-secondary small ms-1 mb-2">Active Players</h6>
            <div class="user-ticker-container">
                <div class="user-ticker-wrapper" id="homeUserTickerEl">
                    <!-- Ticker items will be injected here by JS -->
                </div>
            </div>

            <!-- 8. Esport Games -->
            <h2 class="section-title">Esport Games</h2>
            <div class="row g-3 mb-4 placeholder-glow" id="gamesListEl">
                <div class="col-6"> <div class="game-card custom-card"><span class="placeholder d-block" style="height: 130px; border-top-left-radius: 8px; border-top-right-radius: 8px;"></span><span class="placeholder d-block mt-2 col-8 mx-auto" style="height: 20px;"></span></div> </div> <div class="col-6"> <div class="game-card custom-card"><span class="placeholder d-block" style="height: 130px; border-top-left-radius: 8px; border-top-right-radius: 8px;"></span><span class="placeholder d-block mt-2 col-8 mx-auto" style="height: 20px;"></span></div> </div>
            </div>
            
            <!-- 9. My Contests -->
            <h2 class="section-title">My Contests</h2>
            <div id="myContestsListEl" class="placeholder-glow">
                <div class="tournament-card placeholder-glow mb-3"> <span class="placeholder col-6" style="height: 18px;"></span> <span class="placeholder col-12 mt-2" style="height: 24px;"></span> <span class="placeholder col-10 mt-2" style="height: 16px;"></span> <div class="d-flex justify-content-between mt-3"> <span class="placeholder col-4" style="height: 30px; border-radius: 6px;"></span> <span class="placeholder col-4" style="height: 30px; border-radius: 6px;"></span> </div> </div>
                <p id="noContestsMessageEl" class="text-secondary text-center" style="display: none;">You haven't joined any contests yet.</p>
            </div>
        </section>

        <!-- Tournaments Section -->
        <section id="tournaments-section" class="section">
            <div class="tournament-tabs"> <button class="tab-item active" data-status="upcoming"><i class="bi bi-calendar-event-fill"></i> Upcoming</button> <button class="tab-item" data-status="ongoing"><i class="bi bi-play-circle-fill"></i> Ongoing</button> <button class="tab-item" data-status="completed"><i class="bi bi-trophy-fill"></i> Results</button> </div>
            <div id="tournamentsListContainerEl" class="mt-3 placeholder-glow"> <div class="tournament-card placeholder-glow mb-3"> <span class="placeholder col-6" style="height: 18px;"></span> <span class="placeholder col-12 mt-2" style="height: 24px;"></span> <span class="placeholder col-10 mt-2" style="height: 16px;"></span> <div class="d-flex justify-content-between mt-3"> <span class="placeholder col-4" style="height: 30px; border-radius: 6px;"></span> <span class="placeholder col-4" style="height: 30px; border-radius: 6px;"></span> </div> </div> </div>
            <p id="noTournamentsMessageEl" class="text-secondary text-center mt-4" style="display: none;">No tournaments found.</p>
        </section>

        <!-- Leaderboard Section -->
        <section id="leaderboard-section" class="section">
            <h2 class="section-title">Leaderboard</h2>
            <p class="text-secondary small mb-3">Top players by total wallet balance.</p>
            <div id="leaderboardListEl" class="placeholder-glow">
                 <div class="leaderboard-item"><span class="leaderboard-rank placeholder col-1"></span> <span class="leaderboard-avatar placeholder" style="width: 45px; height: 45px; border-radius: 50%;"></span><span class="leaderboard-name placeholder col-6"></span> <span class="leaderboard-winnings placeholder col-3"></span></div>
                 <div class="leaderboard-item"><span class="leaderboard-rank placeholder col-1"></span> <span class="leaderboard-avatar placeholder" style="width: 45px; height: 45px; border-radius: 50%;"></span><span class="leaderboard-name placeholder col-6"></span> <span class="leaderboard-winnings placeholder col-3"></span></div>
                 <div class="leaderboard-item"><span class="leaderboard-rank placeholder col-1"></span> <span class="leaderboard-avatar placeholder" style="width: 45px; height: 45px; border-radius: 50%;"></span><span class="leaderboard-name placeholder col-6"></span> <span class="leaderboard-winnings placeholder col-3"></span></div>
            </div>
            <p id="noLeaderboardMessageEl" class="text-secondary text-center mt-4" style="display: none;">Leaderboard data is not available yet.</p>
        </section>

        <!-- Update Section -->
        <section id="update-section" class="section">
            <h2 class="section-title">Updates & Notices</h2>
            <div id="updateFeedEl">
                <div class="update-post-card placeholder-glow">
                    <div class="placeholder" style="width: 100%; height: 200px;"></div>
                    <div class="update-post-content">
                        <h4 class="update-post-title placeholder col-8"></h4>
                        <p class="update-post-body placeholder col-12"></p>
                        <p class="update-post-body placeholder col-10"></p>
                    </div>
                </div>
            </div>
             <p id="noUpdatesMessageEl" class="text-secondary text-center mt-4" style="display: none;">No updates available yet.</p>
        </section>

        <!-- Wallet Section -->
        <section id="wallet-section" class="section">
            <div class="wallet-card custom-card">
                <h2 class="section-title mb-4">Wallet</h2>
                <div class="balance-item placeholder-glow"> <span class="balance-item-label">Total Balance</span> <span class="balance-item-value" id="walletTotalBalanceEl"><span class="placeholder col-3"></span></span> <div class="balance-item-action"> <button class="btn-custom-link" id="allTransactionsBtnEl">History <i class="bi bi-chevron-right"></i></button> </div> </div>
                <div class="balance-item placeholder-glow"> <span class="balance-item-label">Winning Cash</span> <span class="balance-item-value" id="walletWinningCashEl"><span class="placeholder col-3"></span></span> <div class="balance-item-action"> </div> </div>
                <div class="balance-item placeholder-glow"> <span class="balance-item-label">Bonus Cash</span> <span class="balance-item-value" id="walletBonusCashEl"><span class="placeholder col-3"></span></span> <div class="balance-item-action" style="min-width: 100px;"></div> </div>
                <div class="d-grid gap-2 mt-4">
                    <button class="btn btn-custom btn-custom-primary" id="withdrawBtnEl"> <i class="bi bi-cash-coin me-2"></i>Withdraw Money</button>
                    <button class="btn btn-custom btn-custom-secondary" id="addAmountWalletBtnEl"> <i class="bi bi-plus-circle-fill me-2"></i>Add Money </button>
                </div>
            </div>
            <h3 class="section-title mt-4">Recent Transactions</h3>
            <div id="recentTransactionsListEl" class="placeholder-glow"> <div class="custom-card p-2 mb-2 placeholder-glow"> <div class="d-flex justify-content-between"> <span class="placeholder col-5" style="height: 16px;"></span> <span class="placeholder col-3" style="height: 16px;"></span> </div> <div class="small text-secondary mt-1"><span class="placeholder col-6" style="height: 14px;"></span></div> </div> <p class="text-secondary text-center mt-3" id="noTransactionsMessageEl" style="display: none;">Loading transactions...</p> </div>
        </section>

        <!-- Profile Section -->
        <section id="profile-section" class="section">
            <div class="profile-header-card placeholder-glow">
                <img src="https://via.placeholder.com/70" alt="Avatar" class="profile-avatar" id="profileAvatarEl">
                
                <div id="profileNameDisplayContainer" class="d-flex align-items-center justify-content-center gap-2 mt-2">
                    <h3 class="profile-name mb-0" id="profileNameEl"><span class="placeholder col-6"></span></h3>
                    <button class="btn btn-sm btn-link p-0" id="editProfileNameBtnEl" style="font-size: 1.1rem; line-height: 1; color: var(--text-secondary);"><i class="bi bi-pencil-square"></i></button>
                </div>
                <div id="editProfileNameContainerEl" class="input-group mt-2 w-75 mx-auto" style="display: none;">
                    <input type="text" class="form-control form-control-sm" id="profileNameInputEl" placeholder="Enter new name">
                    <button class="btn btn-sm btn-custom-accent" id="saveProfileNameBtnEl">Save</button>
                </div>
                
                <p class="profile-email mt-1" id="profileEmailEl"><span class="placeholder col-8"></span></p>
                <div id="profileNameStatusMessageEl" class="alert small py-1" style="display: none;"></div>
                
                <div class="profile-stats w-100">
                    <div class="stat-item"><strong id="profileTotalMatchesEl"><span class="placeholder col-4"></span></strong><span>Matches Played</span></div>
                    <div class="stat-item"><strong id="profileWonMatchesEl"><span class="placeholder col-4"></span></strong><span>Matches Won</span></div>
                    <div class="stat-item"><strong id="profileTotalEarningsEl"><span class="placeholder col-4"></span></strong><span>Total Winnings</span></div>
                </div>
            </div>
            <div class="profile-links">
                <div class="list-group custom-card">
                    <label class="list-group-item list-group-item-action d-flex justify-content-between align-items-center interactive-list-item"> <span><i class="bi bi-bell-fill"></i> Notifications</span> <div class="form-check form-switch"> <input class="form-check-input" type="checkbox" role="switch" id="notificationSwitchEl" checked> </div> </label>
                    <a href="#" class="list-group-item list-group-item-action d-flex justify-content-between align-items-center interactive-list-item" id="liveSupportBtnEl"> <span><i class="bi bi-headset"></i> Live Support</span> <i class="bi bi-chevron-right"></i> </a>
                    <a href="#" class="list-group-item list-group-item-action d-flex justify-content-between align-items-center interactive-list-item" id="contactSupportBtnEl"> <span><i class="bi bi-envelope-fill"></i> Contact Support</span> <i class="bi bi-box-arrow-up-right"></i> </a>
                    <a href="#" class="list-group-item list-group-item-action d-flex justify-content-between align-items-center interactive-list-item" data-policy="refer"> <span><i class="bi bi-person-plus-fill"></i> Refer & Earn</span> <i class="bi bi-chevron-right"></i> </a>
                    <a href="#" class="list-group-item list-group-item-action d-flex justify-content-between align-items:center interactive-list-item" data-policy="privacy"> <span><i class="bi bi-shield-lock-fill"></i> Privacy Policy</span><i class="bi bi-chevron-right"></i> </a>
                    <a href="#" class="list-group-item list-group-item-action d-flex justify-content-between align-items-center interactive-list-item" data-policy="terms"> <span><i class="bi bi-file-text-fill"></i> Terms and Conditions</span><i class="bi bi-chevron-right"></i> </a>
                    <a href="#" class="list-group-item list-group-item-action d-flex justify-content-between align-items-center interactive-list-item" data-policy="refund"> <span><i class="bi bi-arrow-repeat"></i> Refund and Cancellation</span><i class="bi bi-chevron-right"></i> </a>
                    <a href="#" class="list-group-item list-group-item-action d-flex justify-content-between align-items-center interactive-list-item" data-policy="fairPlay"> <span><i class="bi bi-patch-check-fill"></i> Fair Play Policy</span><i class="bi bi-chevron-right"></i> </a>
                    <button class="list-group-item list-group-item-action text-danger d-flex justify-content-between align-items-center interactive-list-item" id="logoutProfileBtnEl"> <span><i class="bi bi-box-arrow-right"></i> Logout</span><span></span> </button>
                </div>
            </div>
        </section>

    </main>

    <!-- Join Tournament Confirmation Modal -->
    <div class="modal fade" id="joinConfirmModalEl" tabindex="-1">
        <div class="modal-dialog modal-dialog-centered">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title">Confirm Join</h5>
                    <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal"></button>
                </div>
                <div class="modal-body">
                    <p id="joinConfirmTextEl">Are you sure you want to join? Please confirm your game ID and name below.</p>
                    <div class="mb-3">
                        <label for="joinGameIdInputEl" class="form-label">Enter Your Game Id</label>
                        <input type="text" class="form-control" id="joinGameIdInputEl" placeholder="e.g., YourGameID123" required>
                    </div>
                    <div class="mb-3">
                        <label for="joinFullNameInputEl" class="form-label">Enter Your Full Name</label>
                        <input type="text" class="form-control" id="joinFullNameInputEl" placeholder="e.g., John Doe" required>
                    </div>
                     <div id="joinStatusMessageEl" class="alert mt-3" style="display: none;"></div>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-custom btn-custom-secondary" data-bs-dismiss="modal">Cancel</button>
                    <button type="button" class="btn btn-custom btn-custom-accent" id="confirmJoinBtnEl">Confirm</button>
                </div>
            </div>
        </div>
    </div>
    
    <!-- Other Modals -->
    <div class="modal fade" id="policyModalEl" tabindex="-1"><div class="modal-dialog modal-dialog-scrollable modal-lg"><div class="modal-content"><div class="modal-header"><h5 class="modal-title" id="policyModalTitleEl">Details</h5><button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal"></button></div><div class="modal-body" id="policyModalBodyEl" style="min-height: 300px;"></div></div></div></div>
    <div class="modal fade" id="rechargeModalEl" tabindex="-1"><div class="modal-dialog modal-dialog-centered"><div class="modal-content"><div class="modal-header"><h5 class="modal-title" id="rechargeModalTitleEl">Recharge</h5><button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal"></button></div><div class="modal-body"><div id="rechargeStep1"><div class="text-center mb-3"><small class="text-secondary">Total Balance</small><h3 class="mb-3" id="rechargeModalBalanceEl">à§³0.00</h3></div><div class="mb-3"><label for="rechargeAmountInputEl" class="form-label">Amount</label><input type="number" class="form-control text-center fs-4" id="rechargeAmountInputEl" placeholder="10 - 1000"><small class="text-secondary d-block text-center mt-1">Minimum: à§³10, Maximum: à§³10000</small></div><div class="d-flex justify-content-center flex-wrap gap-2 my-4" id="presetAmountsContainerEl"><button class="btn btn-custom btn-custom-secondary preset-amount-btn" data-amount="20">à§³20</button><button class="btn btn-custom btn-custom-secondary preset-amount-btn" data-amount="50">à§³50</button><button class="btn btn-custom btn-custom-secondary preset-amount-btn" data-amount="100">à§³100</button><button class="btn btn-custom btn-custom-secondary preset-amount-btn" data-amount="200">à§³200</button><button class="btn btn-custom btn-custom-secondary preset-amount-btn" data-amount="500">à§³500</button><button class="btn btn-custom btn-custom-secondary preset-amount-btn" data-amount="1000">à§³1000</button></div><div class="d-grid"><button class="btn btn-custom btn-custom-primary" id="rechargeNextBtnEl">Recharge</button></div></div><div id="rechargeStep2" style="display: none;"><div class="text-center mb-4"><small class="text-secondary">Recharge Amount</small><h2 class="text-accent" id="rechargeConfirmAmountEl">à§³50.00</h2></div><h6 class="section-title mb-3">Select Payment Method</h6><div class="list-group payment-method-list"><label class="list-group-item list-group-item-action d-flex align-items-center gap-3"><input class="form-check-input" type="radio" name="paymentMethod" value="bKash" id="paymentMethodBkash"><img src="https://iili.io/KJaab3P.png" alt="bKash" style="height: 30px;"><span class="fw-bold">bKash</span></label><label class="list-group-item list-group-item-action d-flex align-items-center gap-3"><input class="form-check-input" type="radio" name="paymentMethod" value="Nagad" id="paymentMethodNagad"><img src="https://i.ibb.co.com/nsg9h7KQ/image-search-1770574083097.png" alt="Nagad" style="height: 30px;"><span class="fw-bold">Nagad</span></label></div><div class="d-grid mt-4"><button class="btn btn-custom btn-custom-primary" id="rechargeProcessBtnEl">Process to Pay</button></div></div><div id="rechargeStep3" style="display: none;"><div class="text-center mb-3"><small class="text-secondary">Recharge Amount</small><h2 id="rechargeFinalAmountEl">à§³50.00</h2><p class="mb-0">Payment Mode: <strong id="rechargeFinalMethodEl">bKash</strong></p></div><div class="text-center my-3"><img id="rechargeQrCodeEl" src="https://iili.io/KJajPup.jpg" alt="QR Code" class="img-fluid rounded" style="max-width: 180px; border: 2px solid var(--border-color); display: none;"><p class="mt-2 mb-0">BIKASH/NAGAT available</p><p>ROKET: <strong class="text-warning" id="rechargePaymentNumberEl">[Number from settings]</strong></p><p>[01305888199]</p></div><p class="small text-warning text-center">After paying, please fill the details below to complete the recharge.TransactionId must be provided </p><div class="mb-3"><label for="rechargeTxnIdInputEl" class="form-label">Type Payment Transaction ID</label><input type="text" class="form-control" id="rechargeTxnIdInputEl" placeholder="Enter Transaction ID here..."></div><div class="mb-3"><label for="rechargeGameIdInputEl" class="form-label">Enter In Your Phone Number</label><input type="text" class="form-control" id="rechargeGameIdInputEl" placeholder="Enter your in-Current phone-number"></div><div id="rechargeStatusMessageEl" class="alert" style="display: none;"></div><div class="d-grid gap-2"><button class="btn btn-custom btn-custom-accent" id="rechargeSubmitBtnEl">Submit</button><button type="button" class="btn btn-custom btn-custom-secondary" id="rechargeBackBtnEl">Back</button></div></div></div></div></div></div>
    
    <!-- Withdraw Modal -->
    <div class="modal fade" id="withdrawModalEl" tabindex="-1"><div class="modal-dialog modal-dialog-centered"><div class="modal-content"><div class="modal-header"><h5 class="modal-title"><i class="bi bi-cash-coin me-2"></i> Withdraw Funds</h5><button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal"></button></div><div class="modal-body"><p class="small text-secondary">Withdrawable balance: <strong class="text-light" id="withdrawModalBalanceEl">à§³0.00</strong></p><div class="mb-3"><label class="form-label">Withdrawal Method</label><div class="list-group payment-method-list"><label class="list-group-item list-group-item-action d-flex align-items-center gap-3"><input class="form-check-input" type="radio" name="withdrawPaymentMethod" value="bKash" id="withdrawMethodBkash" checked><img src="https://iili.io/KJaab3P.png" alt="bKash" style="height: 30px;"><span class="fw-bold">bKash</span></label><label class="list-group-item list-group-item-action d-flex align-items-center gap-3"><input class="form-check-input" type="radio" name="withdrawPaymentMethod" value="Nagad" id="withdrawMethodNagad"><img src="https://iili.io/KJacOHF.jpg" alt="Nagad" style="height: 30px;"><span class="fw-bold">Nagad</span></label></div></div><div class="mb-3"><label for="withdrawAccountInputEl" class="form-label">Account Number</label><input type="tel" class="form-control" id="withdrawAccountInputEl" placeholder="Enter your account phone number"></div><div class="mb-3"><label for="withdrawAmountInputEl" class="form-label">Amount (Min à§³<span id="minWithdrawAmountEl">50</span>)</label><input type="number" class="form-control" id="withdrawAmountInputEl" placeholder="Enter amount"></div><div id="withdrawStatusMessageEl" class="alert mt-3" style="display: none;"></div></div><div class="modal-footer"><button type="button" class="btn btn-custom btn-custom-secondary" data-bs-dismiss="modal">Cancel</button><button type="button" class="btn btn-custom btn-custom-primary" id="submitWithdrawRequestBtnEl">Submit Request</button></div></div></div></div>

    <div class="modal fade" id="matchDetailsModalEl" tabindex="-1"><div class="modal-dialog modal-dialog-centered modal-lg"><div class="modal-content"><div class="modal-header"><h5 class="modal-title" id="matchDetailsModalTitleEl">Match Details</h5><button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal"></button></div><div class="modal-body" id="matchDetailsModalBodyEl"></div></div></div></div>
    <div class="modal fade" id="idPasswordModalEl" tabindex="-1"><div class="modal-dialog modal-dialog-centered"><div class="modal-content"><div class="modal-header"><h5 class="modal-title">Room ID & Password</h5><button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal"></button></div><div class="modal-body text-center"><p class="small text-secondary">ID/Pass shown shortly before match start.</p><div class="my-3 p-3" style="background: var(--primary-bg); border-radius: 8px;"><p class="mb-1">Room ID:</p><h4 id="roomIdDisplayEl" class="text-accent referral-code placeholder-glow d-inline-block"><span class="placeholder col-6"></span></h4><button class="btn btn-sm btn-outline-warning ms-2 copy-btn" data-target="#roomIdDisplayEl" title="Copy Room ID"><i class="bi bi-clipboard"></i></button></div><div class="my-3 p-3" style="background: var(--primary-bg); border-radius: 8px;"><p class="mb-1">Password:</p><h4 id="roomPasswordDisplayEl" class="text-accent referral-code placeholder-glow d-inline-block"><span class="placeholder col-6"></span></h4><button class="btn btn-sm btn-outline-warning ms-2 copy-btn" data-target="#roomPasswordDisplayEl" title="Copy Password"><i class="bi bi-clipboard"></i></button></div><p class="small text-warning"><i class="bi bi-exclamation-triangle"></i> Don't share ID/Password.</p></div></div></div></div>
    <div class="modal fade" id="notificationsModalEl" tabindex="-1"><div class="modal-dialog modal-dialog-scrollable"><div class="modal-content"><div class="modal-header"><h5 class="modal-title"><i class="bi bi-bell-fill me-2"></i> Notifications</h5><button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal"></button></div><div class="modal-body p-0"><div class="list-group list-group-flush" id="notificationsListEl"><p class="text-secondary text-center p-4" id="noNotificationsMessageEl">No notifications yet.</p></div></div></div></div></div>

    <!-- Comments Modal -->
    <div class="modal fade" id="commentsModalEl" tabindex="-1"><div class="modal-dialog modal-dialog-centered modal-dialog-scrollable"><div class="modal-content"><div class="modal-header"><h5 class="modal-title">Comments</h5><button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal"></button></div><div class="modal-body"><div class="comment-list" id="commentsListEl"><p class="text-center text-secondary">No comments yet.</p></div></div><div class="modal-footer"><div class="message-input-group w-100"><input type="text" class="form-control" id="commentInputEl" placeholder="Add a comment..."><button class="btn btn-custom btn-custom-accent" id="sendCommentBtnEl"><i class="bi bi-send-fill"></i></button></div></div></div></div></div>
    
    <!-- Live Support Modal -->
    <div class="modal fade" id="liveSupportModalEl" tabindex="-1"><div class="modal-dialog modal-dialog-centered modal-dialog-scrollable"><div class="modal-content"><div class="modal-header"><h5 class="modal-title"><i class="bi bi-headset"></i> Live Support</h5><button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal"></button></div><div class="modal-body"><div class="chat-messages" id="liveSupportMessagesEl"></div></div><div class="modal-footer"><div class="message-input-group w-100"><input type="text" class="form-control" id="liveSupportInputEl" placeholder="Type your message..."><button class="btn btn-custom btn-custom-primary" id="sendLiveSupportBtnEl"><i class="bi bi-send-fill"></i></button></div></div></div></div></div>

    <!-- NEW: Social Media Modal -->
    <div class="modal fade" id="socialMediaModalEl" tabindex="-1">
        <div class="modal-dialog modal-dialog-centered">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title"><i class="bi bi-person-heart me-2"></i>Follow Us</h5>
                    <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal"></button>
                </div>
                <div class="modal-body">
                    <p class="text-center text-secondary">Stay connected with us on our social media channels for the latest updates, news, and events!</p>
                    <div class="social-icons-modal-wrapper" id="socialIconsModalWrapperEl">
                        <!-- Social icons injected by JS -->
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- NEW: Promo Code Modal -->
    <div class="modal fade" id="promoCodeModalEl" tabindex="-1">
        <div class="modal-dialog modal-dialog-centered">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title"><i class="bi bi-gift-fill me-2"></i>Claim Promo Code</h5>
                    <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal"></button>
                </div>
                <div class="modal-body">
                    <p class="text-secondary small">Enter a valid promo code to claim your reward.</p>
                    <div class="mb-3">
                        <label for="promoCodeInputEl" class="form-label">Promo Code</label>
                        <input type="text" class="form-control" id="promoCodeInputEl" placeholder="e.g., WELCOME50">
                    </div>
                    <div id="promoCodeStatusMessageEl" class="alert mt-3" style="display: none;"></div>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-custom btn-custom-secondary" data-bs-dismiss="modal">Cancel</button>
                    <button type="button" class="btn btn-custom btn-custom-accent" id="claimPromoCodeBtnEl">Claim Reward</button>
                </div>
            </div>
        </div>
    </div>

    <!-- Bottom Navigation -->
    <nav class="bottom-nav">
        <button class="nav-item active" data-section="home-section"><i class="bi bi-house-door-fill"></i><span>Home</span></button>
        <button class="nav-item" data-section="leaderboard-section"><i class="bi bi-trophy-fill"></i><span>Leaderboard</span></button>
        <button class="nav-item" data-section="update-section"><i class="bi bi-newspaper"></i><span>Update</span></button>
        <button class="nav-item" data-section="wallet-section"><i class="bi bi-wallet-fill"></i><span>Wallet</span></button>
        <button class="nav-item" data-section="profile-section"><i class="bi bi-person-fill"></i><span>Profile</span></button>
    </nav>

    <!-- JS Libraries -->
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/js/bootstrap.bundle.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/swiper@11/swiper-bundle.min.js"></script>

    <!-- Firebase SDK & App Logic -->
    <script type="module">
        // Firebase Imports
        import { initializeApp } from "https://www.gstatic.com/firebasejs/9.22.0/firebase-app.js";
        import { getDatabase, ref, get, set, update, push, query, orderByChild, equalTo, onValue, runTransaction, off, limitToLast, serverTimestamp } from "https://www.gstatic.com/firebasejs/9.22.0/firebase-database.js";
        import { getAuth, GoogleAuthProvider, signInWithPopup, signOut, onAuthStateChanged, createUserWithEmailAndPassword, signInWithEmailAndPassword, sendPasswordResetEmail } from "https://www.gstatic.com/firebasejs/9.22.0/firebase-auth.js";

        // ===============================================================
        const firebaseConfig = {
            apiKey: "AIzaSyBhE8HNbhHcL_DlGWDW4zu3AvE8VSeA8zE",
            authDomain: "l-tournament-10594.firebaseapp.com",
            databaseURL: "https://l-tournament-10594-default-rtdb.firebaseio.com",
            projectId: "l-tournament-10594",
            storageBucket: "l-tournament-10594.firebasestorage.app",
            messagingSenderId: "517389311136",
            appId: "1:517389311136:web:c05c333a3a15465fd37dc5"
        };
        // ===============================================================

        // Initialize Firebase
        let app, db, auth;
        try {
            app = initializeApp(firebaseConfig);
            db = getDatabase(app);
            auth = getAuth(app);
            console.log("Firebase Initialized");
        } catch (error) {
            console.error("Firebase initialization failed:", error);
            document.body.innerHTML = `<div class="alert alert-danger m-5">Critical Error: Could not connect. Check Firebase config.</div>`;
        }

        // --- DOM Elements Cache ---
         const getElement = (id) => document.getElementById(id);
         const querySel = (selector) => document.querySelector(selector);
         const querySelAll = (selector) => document.querySelectorAll(selector);
         const elements = {
             sections: querySelAll('.section'), bottomNavItems: querySelAll('.bottom-nav .nav-item'), globalLoader: getElement('globalLoaderEl'),
             headerBackBtn: getElement('headerBackBtnEl'), headerTitleContainer: getElement('headerTitleContainerEl'), headerGameTitle: getElement('headerGameTitleEl'), headerWalletChip: getElement('headerWalletChipEl'), headerChipBalance: getElement('headerChipBalanceEl'), headerUserGreeting: getElement('headerUserGreetingEl'), appLogo: getElement('appLogoEl'), notificationBtn: getElement('notificationBtnEl'), notificationBadge: querySel('.notification-badge'),
             loginSection: getElement('login-section'), loginLogo: getElement('loginLogoEl'),
             emailLoginForm: getElement('emailLoginForm'), loginEmailInput: getElement('loginEmailInputEl'), loginPasswordInput: getElement('loginPasswordInputEl'), loginEmailBtn: getElement('loginEmailBtnEl'), showSignupToggleBtn: getElement('showSignupToggleBtnEl'), loginStatusMessage: getElement('loginStatusMessageEl'), forgotPasswordLink: getElement('forgotPasswordLinkEl'),
             emailSignupForm: getElement('emailSignupForm'), signupEmailInput: getElement('signupEmailInputEl'), signupPasswordInput: getElement('signupPasswordInputEl'), signupConfirmPasswordInput: getElement('signupConfirmPasswordInputEl'), signupReferralCodeInput: getElement('signupReferralCodeInputEl'), signupEmailBtn: getElement('signupEmailBtnEl'), showLoginToggleBtn: getElement('showLoginToggleBtnEl'), signupStatusMessage: getElement('signupStatusMessageEl'),
             homeSection: getElement('home-section'), promotionSlider: getElement('promotionSliderEl'), gamesList: getElement('gamesListEl'), myContestsList: getElement('myContestsListEl'), noContestsMessage: getElement('noContestsMessageEl'),
             
             // Home Page Elements
             homeTabs: querySelAll('.home-tab-box'),
             homeUserTicker: getElement('homeUserTickerEl'),
             // NEW: Elements from request
             marqueeContainer: getElement('marqueeContainerEl'),
             marqueeText: getElement('marqueeTextEl'),
             timeDashboard: getElement('timeDashboardEl'),
             timeEl: getElement('timeDashboardTimeEl'),
             dateEl: getElement('timeDashboardDateEl'),
             dayEl: getElement('timeDashboardDayEl'),
             homeBannerContainer: getElement('homeBannerContainerEl'),
             // NEW: Elements for new features
             featuresDashboardEl: getElement('featuresDashboardEl'),
             socialMediaModalInstance: getElement('socialMediaModalEl') ? new bootstrap.Modal(getElement('socialMediaModalEl')) : null,
             socialIconsModalWrapperEl: getElement('socialIconsModalWrapperEl'),
             promoCodeModalInstance: getElement('promoCodeModalEl') ? new bootstrap.Modal(getElement('promoCodeModalEl')) : null,
             promoCodeInputEl: getElement('promoCodeInputEl'),
             claimPromoCodeBtnEl: getElement('claimPromoCodeBtnEl'),
             promoCodeStatusMessageEl: getElement('promoCodeStatusMessageEl'),
             
             tournamentsSection: getElement('tournaments-section'), tournamentsListContainer: getElement('tournamentsListContainerEl'), noTournamentsMessage: getElement('noTournamentsMessageEl'), tournamentTabs: querySelAll('.tournament-tabs .tab-item'),
             walletSection: getElement('wallet-section'), walletTotalBalance: getElement('walletTotalBalanceEl'), walletWinningCash: getElement('walletWinningCashEl'), walletBonusCash: getElement('walletBonusCashEl'), allTransactionsBtn: getElement('allTransactionsBtnEl'), withdrawBtn: getElement('withdrawBtnEl'), addAmountWalletBtn: getElement('addAmountWalletBtnEl'), recentTransactionsList: getElement('recentTransactionsListEl'), noTransactionsMessage: getElement('noTransactionsMessageEl'),
             profileSection: getElement('profile-section'), profileAvatar: getElement('profileAvatarEl'), profileName: getElement('profileNameEl'), profileEmail: getElement('profileEmailEl'), profileTotalMatches: getElement('profileTotalMatchesEl'), profileWonMatches: getElement('profileWonMatchesEl'), profileTotalEarnings: getElement('profileTotalEarningsEl'), logoutProfileBtn: getElement('logoutProfileBtnEl'), policyLinks: querySelAll('.profile-links a[data-policy], .profile-links button[data-policy]'), notificationSwitch: getElement('notificationSwitchEl'),
             
             editProfileNameBtnEl: getElement('editProfileNameBtnEl'),
             saveProfileNameBtnEl: getElement('saveProfileNameBtnEl'),
             profileNameInputEl: getElement('profileNameInputEl'),
             editProfileNameContainerEl: getElement('editProfileNameContainerEl'),
             profileNameDisplayContainer: getElement('profileNameDisplayContainer'),
             profileNameStatusMessageEl: getElement('profileNameStatusMessageEl'),

             leaderboardSection: getElement('leaderboard-section'),
             leaderboardList: getElement('leaderboardListEl'),
             noLeaderboardMessage: getElement('noLeaderboardMessageEl'),

             updateSection: getElement('update-section'),
             updateFeed: getElement('updateFeedEl'),
             noUpdatesMessage: getElement('noUpdatesMessageEl'),

             liveSupportBtn: getElement('liveSupportBtnEl'),
             contactSupportBtnEl: getElement('contactSupportBtnEl'),

             policyModalInstance: getElement('policyModalEl') ? new bootstrap.Modal(getElement('policyModalEl')) : null, policyModalTitle: getElement('policyModalTitleEl'), policyModalBody: getElement('policyModalBodyEl'),
             notificationsModalInstance: getElement('notificationsModalEl') ? new bootstrap.Modal(getElement('notificationsModalEl')) : null, notificationsList: getElement('notificationsListEl'), noNotificationsMessage: getElement('noNotificationsMessageEl'),
             rechargeModalInstance: getElement('rechargeModalEl') ? new bootstrap.Modal(getElement('rechargeModalEl')) : null, rechargeModalTitle: getElement('rechargeModalTitleEl'), rechargeStep1: getElement('rechargeStep1'), rechargeStep2: getElement('rechargeStep2'), rechargeStep3: getElement('rechargeStep3'), rechargeModalBalance: getElement('rechargeModalBalanceEl'), rechargeAmountInput: getElement('rechargeAmountInputEl'), presetAmountsContainer: getElement('presetAmountsContainerEl'), rechargeNextBtn: getElement('rechargeNextBtnEl'), rechargeConfirmAmount: getElement('rechargeConfirmAmountEl'), rechargeProcessBtn: getElement('rechargeProcessBtnEl'), rechargeFinalAmount: getElement('rechargeFinalAmountEl'), rechargeFinalMethod: getElement('rechargeFinalMethodEl'), rechargeQrCode: getElement('rechargeQrCodeEl'), rechargePaymentNumber: getElement('rechargePaymentNumberEl'), rechargeTxnIdInput: getElement('rechargeTxnIdInputEl'), rechargeGameIdInput: getElement('rechargeGameIdInputEl'), rechargeStatusMessage: getElement('rechargeStatusMessageEl'), rechargeSubmitBtn: getElement('rechargeSubmitBtnEl'), rechargeBackBtn: getElement('rechargeBackBtnEl'),
             withdrawModalInstance: getElement('withdrawModalEl') ? new bootstrap.Modal(getElement('withdrawModalEl')) : null, withdrawModalBalance: getElement('withdrawModalBalanceEl'), withdrawAmountInput: getElement('withdrawAmountInputEl'), withdrawAccountInput: getElement('withdrawAccountInputEl'), minWithdrawAmount: getElement('minWithdrawAmountEl'), withdrawStatusMessage: getElement('withdrawStatusMessageEl'), submitWithdrawRequestBtn: getElement('submitWithdrawRequestBtnEl'),
             matchDetailsModalInstance: getElement('matchDetailsModalEl') ? new bootstrap.Modal(getElement('matchDetailsModalEl')) : null, matchDetailsModalTitle: getElement('matchDetailsModalTitleEl'), matchDetailsModalBody: getElement('matchDetailsModalBodyEl'),
             idPasswordModalInstance: getElement('idPasswordModalEl') ? new bootstrap.Modal(getElement('idPasswordModalEl')) : null, roomIdDisplay: getElement('roomIdDisplayEl'), roomPasswordDisplay: getElement('roomPasswordDisplayEl'),
             joinConfirmModalInstance: getElement('joinConfirmModalEl') ? new bootstrap.Modal(getElement('joinConfirmModalEl')) : null,
             joinConfirmTextEl: getElement('joinConfirmTextEl'),
             joinGameIdInputEl: getElement('joinGameIdInputEl'),
             joinFullNameInputEl: getElement('joinFullNameInputEl'),
             joinStatusMessageEl: getElement('joinStatusMessageEl'),
             confirmJoinBtnEl: getElement('confirmJoinBtnEl'),

             commentsModalInstance: getElement('commentsModalEl') ? new bootstrap.Modal(getElement('commentsModalEl')) : null,
             commentsList: getElement('commentsListEl'),
             commentInput: getElement('commentInputEl'),
             sendCommentBtn: getElement('sendCommentBtnEl'),

             liveSupportModalInstance: getElement('liveSupportModalEl') ? new bootstrap.Modal(getElement('liveSupportModalEl')) : null,
             liveSupportMessages: getElement('liveSupportMessagesEl'),
             liveSupportInput: getElement('liveSupportInputEl'),
             sendLiveSupportBtn: getElement('sendLiveSupportBtnEl'),

             securityWarning: getElement('securityWarning')
         };

        // --- App State ---
        let currentUser = null; let userProfile = {}; let currentSectionId = 'login-section'; let dbListeners = {};
        let swiperInstance; let currentTournamentGameId = null; let appSettings = {};
        let validReferrerUid = null; 
        let rechargeState = { amount: 0, method: '' };

        // --- Utility & Theme Functions ---
        const defaultTheme={'--primary-bg':'#0F172A','--secondary-bg':'#1E293B','--card-bg':'#1E293B','--text-primary':'#E2E8F0','--text-secondary':'#94A3B8','--accent-color':'#FACC15','--accent-gradient':'linear-gradient(to right, #FACC15, #FBBF24)','--primary-button-bg':'#3B82F6','--border-color':'#334155','--bottom-nav-bg':'#1E293B','--success-color':'#10B981','--danger-color':'#EF4444','--warning-color':'#F59E0B','--info-color':'#3B82F6'};function applyTheme(e){const t=document.documentElement;if(e&&"object"==typeof e){console.log("Applying custom theme:",e);for(const o in defaultTheme)e[o]?t.style.setProperty(o,e[o]):t.style.removeProperty(o)}else{console.log("Resetting to default theme.");for(const o in defaultTheme)t.style.removeProperty(o)}}
        const showLoader=(e)=>{if(elements.globalLoader)elements.globalLoader.style.display=e?"flex":"none"};function showStatusMessage(e,t,o="danger",s=!0){e&&(e.innerHTML=t,e.className=`alert alert-${o} mt-3`,e.style.display="block",e.setAttribute("role","alert"),s&&setTimeout(()=>{e.innerHTML===t&&(e.style.display="none")},5e3))}function clearStatusMessage(e){e&&(e.style.display="none",e.innerHTML="",e.removeAttribute("role"))}function copyToClipboard(e){if(!e)return void alert("Copy target not defined.");const t=querySel(e);if(!t)return void alert("Element to copy from not found.");const o=t.textContent;o&&"N/A"!==o&&!o.includes("placeholder")?navigator.clipboard.writeText(o).then(()=>{alert("Copied!")}).catch(e=>{console.error("Failed to copy:",e),alert("Failed to copy.")}):alert("Nothing to copy.")}function shareReferral(e){navigator.share?e&&"N/A"!==e?navigator.share({title:"Join Me on Gaming Tournament!",text:`Join using my referral code: ${e} & get rewards! App: ${window.location.origin}`,url:window.location.origin}).catch(e=>console.log("Error sharing",e)):alert("Referral code not available."):alert("Web Share not supported. Copy the code manually.")}function generateReferralCode(e=8){let t="",o="ABCDEFGHIJKLMNOPQRSTUVWXYZ0123456789";for(let s=0;s<e;s++)t+=o.charAt(Math.floor(Math.random()*o.length));return t}function getTimeRemaining(e){if(!e)return"TBA";const t=Date.now(),o=e-t;if(o<=0)return"Starting Soon";const s=Math.floor(o/864e5),n=Math.floor(o%864e5/36e5),a=Math.floor(o%36e5/6e4);let r="";return s>0&&(r+=`${s}d `),(n>0||s>0)&&(r+=`${n}h `),r+=`${a}m`,r.trim()||"Now"}const removePlaceholders=e=>{if(e){e.classList.remove("placeholder-glow"),e.querySelectorAll(".placeholder").forEach(e=>e.remove())}};

        // --- UI Functions ---
         function showSection(sectionId) {
             if (!auth || !sectionId || !elements.sections) { console.error("Cannot show section", sectionId); return; }
             const targetSection = getElement(sectionId); if (!targetSection) { console.error(`Section element "${sectionId}" not found.`); showSection(currentUser ? 'home-section' : 'login-section'); return; }
             const protectedSections = ['home-section', 'wallet-section', 'profile-section', 'tournaments-section', 'leaderboard-section', 'update-section'];
             const isLoggedIn = !!currentUser;
             if (protectedSections.includes(sectionId) && !isLoggedIn) { showSection('login-section'); return; }
             if (sectionId === 'login-section' && isLoggedIn) { showSection('home-section'); return; }
             elements.sections.forEach(sec => sec.classList.remove('active')); targetSection.classList.add('active'); currentSectionId = sectionId;
             updateHeaderForSection(sectionId);
             elements.bottomNavItems.forEach(item => item.classList.toggle('active', item.dataset.section === sectionId));
             console.log(`Loading data for section: ${sectionId}`);
             switch (sectionId) {
                 case 'home-section': loadHomePageData(); break;
                 case 'wallet-section': loadWalletData(); break;
                 case 'profile-section': loadProfileData(); break;
                 case 'leaderboard-section': loadLeaderboardData(); break; 
                 case 'update-section': loadUpdateFeedData(); break; 
                 case 'tournaments-section': if(currentTournamentGameId) { const activeTab = querySel('.tournament-tabs .tab-item.active')?.dataset.status || 'upcoming'; filterTournaments(currentTournamentGameId, activeTab); } else { elements.tournamentsListContainer.innerHTML = '<p class="text-secondary text-center mt-4">Select a game from Home page first.</p>'; } break;
             }
             if (sectionId === 'login-section') { toggleLoginForm(true); } 
             window.scrollTo(0, 0);
         }
         function updateHeaderForSection(sectionId) { const showBackButton = (sectionId === 'tournaments-section'); const defaultTitleVisible = !showBackButton; const gameTitleVisible = showBackButton; if (elements.headerBackBtn) elements.headerBackBtn.style.display = showBackButton ? 'inline-block' : 'none'; if (elements.headerTitleContainer) elements.headerTitleContainer.style.display = defaultTitleVisible ? 'flex' : 'none'; if (elements.headerGameTitle) elements.headerGameTitle.style.display = gameTitleVisible ? 'block' : 'none'; if (gameTitleVisible && currentTournamentGameId && elements.headerGameTitle) { const gameName = appSettings?.games?.[currentTournamentGameId]?.name || `Game`; elements.headerGameTitle.textContent = gameName; } else if (defaultTitleVisible && elements.headerUserGreeting) { const nameToShow = userProfile?.displayName?.split(' ')[0] || (currentUser ? currentUser.email?.split('@')[0] : 'Guest') || 'Guest'; elements.headerUserGreeting.textContent = nameToShow; } }
         function updateGlobalUI(isLoggedIn) { if (elements.headerWalletChip) { elements.headerWalletChip.style.display = isLoggedIn ? 'flex' : 'none'; if (isLoggedIn) elements.headerWalletChip.onclick = () => showSection('wallet-section'); else elements.headerWalletChip.onclick = null; } if (!isLoggedIn && elements.headerUserGreeting) elements.headerUserGreeting.textContent = 'Guest'; if (!isLoggedIn && elements.headerChipBalance) elements.headerChipBalance.textContent = '0'; elements.bottomNavItems.forEach(item => { const section = item.dataset.section; item.style.display = 'flex'; }); }
         
        function populateUserInfo(user, profile) {
            if (!user || !profile) return;
            const displayName = profile.displayName || user.displayName || user.email?.split('@')[0] || 'User';
            const photoURL = profile.photoURL || user.photoURL || `https://ui-avatars.com/api/?name=${encodeURIComponent(displayName)}&background=0F172A&color=E2E8F0&bold=true&size=70`;
            const winningCash = (profile.winningCash || 0);
            const bonusCash = (profile.bonusCash || 0);
            const totalBalance = winningCash + bonusCash; 
            const totalEarnings = (profile.totalEarnings || 0);
            const totalMatches = profile.totalMatches || 0;
            const wonMatches = profile.wonMatches || 0;
            const formatCurrency = (amount) => `à§³${amount.toFixed(2)}`;
            if (elements.headerUserGreeting) elements.headerUserGreeting.textContent = displayName.split(' ')[0];
            if (elements.headerChipBalance) elements.headerChipBalance.textContent = Math.floor(totalBalance);
            if (elements.walletTotalBalance) {
                elements.walletTotalBalance.textContent = formatCurrency(totalBalance);
                removePlaceholders(elements.walletTotalBalance.closest('.placeholder-glow'));
            }
            if (elements.walletWinningCash) {
                elements.walletWinningCash.textContent = formatCurrency(winningCash);
                removePlaceholders(elements.walletWinningCash.closest('.placeholder-glow'));
            }
            if (elements.walletBonusCash) {
                elements.walletBonusCash.textContent = formatCurrency(bonusCash);
                removePlaceholders(elements.walletBonusCash.closest('.placeholder-glow'));
            }
            if (elements.withdrawModalBalance) elements.withdrawModalBalance.textContent = formatCurrency(totalBalance); 
            if (elements.profileAvatar) elements.profileAvatar.src = photoURL;
            if (elements.profileName) {
                elements.profileName.textContent = displayName;
                removePlaceholders(elements.profileName.closest('.placeholder-glow'));
            }
            if (elements.profileEmail) {
                elements.profileEmail.textContent = user.email || 'N/A';
                removePlaceholders(elements.profileEmail.closest('.placeholder-glow'));
            }
            if (elements.profileTotalMatches) {
                elements.profileTotalMatches.textContent = totalMatches;
                removePlaceholders(elements.profileTotalMatches.closest('.placeholder-glow'));
            }
            if (elements.profileWonMatches) {
                elements.profileWonMatches.textContent = wonMatches;
                removePlaceholders(elements.profileWonMatches.closest('.placeholder-glow'));
            }
            if (elements.profileTotalEarnings) {
                elements.profileTotalEarnings.textContent = formatCurrency(totalEarnings);
                removePlaceholders(elements.profileTotalEarnings.closest('.placeholder-glow'));
            }
        }
        function toggleLoginForm(showLogin) { if (!elements.emailLoginForm || !elements.emailSignupForm) return; clearStatusMessage(elements.loginStatusMessage); clearStatusMessage(elements.signupStatusMessage); elements.emailLoginForm.style.display = showLogin ? 'block' : 'none'; elements.emailSignupForm.style.display = showLogin ? 'none' : 'block'; elements.emailLoginForm.reset(); elements.emailSignupForm.reset(); }
        
        // --- Firebase Auth & DB Functions ---
        async function signUpWithEmail(){if(auth){const e=elements.signupEmailInput.value.trim(),t=elements.signupPasswordInput.value,o=elements.signupConfirmPasswordInput.value,s=elements.signupReferralCodeInput.value.trim();if(!e||!t||!o)return void showStatusMessage(elements.signupStatusMessage,"Fill required fields.","warning");if(t!==o)return void showStatusMessage(elements.signupStatusMessage,"Passwords don't match.","warning");if(t.length<6)return void showStatusMessage(elements.signupStatusMessage,"Password min 6 chars.","warning");showLoader(!0),clearStatusMessage(elements.signupStatusMessage),validReferrerUid=null;try{if(s){console.log("Validating referral code:",s);const n=ref(db,"users"),a=query(n,orderByChild("referralCode"),equalTo(s)),r=await get(a);if(r.exists()){const l=r.val(),c=Object.keys(l)[0],i=l[c];c&&i.email?validReferrerUid=c:console.warn("Referral code found, but referrer data invalid:",l)}else console.log("Referral code not found:",s)}await createUserWithEmailAndPassword(auth,e,t)}catch(u){console.error("Signup Error:",u);let d="Signup failed.";switch(u.code){case"auth/email-already-in-use":d="Email already registered.";break;case"auth/weak-password":d="Password too weak.";break;case"auth/invalid-email":d="Invalid email.";break;case"auth/network-request-failed":d="Network error.";break;default:d=`Error: ${u.message}`}showStatusMessage(elements.signupStatusMessage,d,"danger")}finally{showLoader(!1)}}}async function loginWithEmail(){if(auth){const e=elements.loginEmailInput.value.trim(),t=elements.loginPasswordInput.value;if(!e||!t)return void showStatusMessage(elements.loginStatusMessage,"Enter email & password.","warning");showLoader(!0),clearStatusMessage(elements.loginStatusMessage);try{await signInWithEmailAndPassword(auth,e,t)}catch(o){console.error("Login Error:",o);let s="Login failed.";switch(o.code){case"auth/user-not-found":case"auth/wrong-password":case"auth/invalid-credential":s="Invalid email or password.";break;case"auth/invalid-email":s="Invalid email format.";break;case"auth/too-many-requests":s="Too many attempts. Reset pass or wait.";break;case"auth/network-request-failed":s="Network error.";break;case"auth/user-disabled":s="Account disabled.";break;default:s=`Error: ${o.message}`}showStatusMessage(elements.loginStatusMessage,s,"danger")}finally{showLoader(!1)}}}async function resetPassword(){if(auth){const e=elements.loginEmailInput.value.trim();if(!e)return void showStatusMessage(elements.loginStatusMessage,"Enter email for password reset.","warning");showLoader(!0),clearStatusMessage(elements.loginStatusMessage);try{await sendPasswordResetEmail(auth,e),showStatusMessage(elements.loginStatusMessage,"Password reset email sent! Check inbox/spam.","success",!1)}catch(t){console.error("Reset Pass Error:",t);let o="Failed to send email.";switch(t.code){case"auth/user-not-found":case"auth/invalid-email":o="Email not found.";break;case"auth/network-request-failed":o="Network error.";break;default:o=`Error: ${t.message}`}showStatusMessage(elements.loginStatusMessage,o,"danger")}finally{showLoader(!1)}}}async function logoutUser(){if(auth)try{showLoader(!0),await signOut(auth)}catch(e){console.error("Sign Out Error:",e),alert(`Logout failed: ${e.message}`),showLoader(!1)}}
        async function handleAuthStateChange(e){if(!auth||!db)return console.error("Firebase not ready in auth change"),void showLoader(!1);showLoader(!0),detachAllDbListeners(),currentUser=e;const t=validReferrerUid;if(validReferrerUid=null,e){console.log("Auth State: Logged In",e.uid);const o=ref(db,"users/"+e.uid);try{const s=await get(o);if(s.exists()){userProfile=s.val();const n={};e.displayName&&(!userProfile.displayName||userProfile.displayName!==e.displayName)&&(n.displayName=e.displayName),e.email&&!userProfile.email&&(n.email=e.email),Object.keys(n).length>0&&(await update(o,n),userProfile={...userProfile,...n})}else{console.log("New user, creating profile...");const a={uid:e.uid,displayName:e.displayName||e.email?.split("@")[0]||"User",email:e.email||null,photoURL:e.photoURL||null,winningCash:0,bonusCash:appSettings.newUserBonus||0,totalMatches:0,wonMatches:0,totalEarnings:0,referralEarnings:0,createdAt:Date.now(),referralCode:generateReferralCode(),joinedTournaments:{},isAdmin:!1,...t&&{referredBy:t}};if(await set(o,a),userProfile=a,a.bonusCash>0&&await recordTransaction(e.uid,"signup_bonus",a.bonusCash,"Welcome Bonus"),t&&appSettings.referralBonus>0){console.log(`Awarding referral bonus of ${appSettings.referralBonus} to referrer: ${t}`);const r=ref(db,`users/${t}`);try{const l=await runTransaction(r,e=>{if(e)return e.bonusCash=(e.bonusCash||0)+appSettings.referralBonus,e.referralEarnings=(e.referralEarnings||0)+appSettings.referralBonus,e.totalEarnings=(e.totalEarnings||0)+appSettings.referralBonus,e;});l.committed?(await recordTransaction(t,"referral_bonus",appSettings.referralBonus,`Referral Bonus from ${a.displayName||a.email}`),console.log("Referrer bonus awarded successfully.")):console.error("Referrer bonus transaction aborted.")}catch(c){console.error("Error awarding referrer bonus:",c)}}}populateUserInfo(e,userProfile),setupRealtimeListeners(e.uid),loadNotifications(e.uid),updateGlobalUI(!0);const i="login-section"===currentSectionId||!getElement(currentSectionId)?"home-section":currentSectionId;showSection(i)}catch(u){console.error("Profile handling error:",u),alert("Error loading profile. Logging out. "+u.message);try{await logoutUser()}catch(d){}}}else console.log("Auth State: Logged Out"),currentUser=null,userProfile={},updateGlobalUI(!1),showSection("login-section");showLoader(!1)}
        
        function loadAppSettings(){console.log("Attaching listener for App Settings...");const e=ref(db,"settings");dbListeners.settings&&(off(e,"value",dbListeners.settings.func),delete dbListeners.settings);const t=onValue(e,e=>{if(e.exists()){appSettings=e.val()||{},console.log("App Settings Updated (Real-time):",appSettings),applyTheme(appSettings.theme||null); if (appSettings.logoUrl) { elements.appLogo.src = appSettings.logoUrl; elements.loginLogo.src = appSettings.logoUrl; } appSettings.minWithdraw&&elements.minWithdrawAmount&&(elements.minWithdrawAmount.textContent=appSettings.minWithdraw);const t=document.querySelector(".phonepe-number");t&&(t.textContent=appSettings.upiDetails||"[!!! YOUR UPI ID/NUMBER HERE !!!]");const o=document.querySelector(".modal-body p strong#modalUserEmailEl")?.closest("p");o&&appSettings.supportContact?o.innerHTML=o.innerHTML.replace(/\[!!! ADMIN CONTACT INFO HERE !!!\]/g,appSettings.supportContact):o&&(o.innerHTML=o.innerHTML.replace(appSettings.supportContact||"some_previous_value","[!!! ADMIN CONTACT INFO HERE !!!]")); updateMarquee(); populateSocialMediaModal(); updateHomeBanner();}else{console.warn("App Settings not found in database! Using defaults."),appSettings={},applyTheme(null);const e=document.querySelector(".phonepe-number");e&&(e.textContent="[!!! YOUR UPI ID/NUMBER HERE !!!]");const t=document.querySelector(".modal-body p strong#modalUserEmailEl")?.closest("p");t&&(t.innerHTML=t.innerHTML.replace(/.*/,'<strong><i class="bi bi-exclamation-triangle-fill text-warning"></i> IMPORTANT:</strong> After payment, contact admin via [!!! ADMIN CONTACT INFO HERE !!!] with registered Email (<strong id="modalUserEmailEl">...</strong>) & payment screenshot. Amount added manually after verification.'))}},e=>{console.error("Settings listener failed",e),appSettings={},applyTheme(null)});dbListeners.settings={path:"settings",func:t}}
        function loadHomePageData(){console.log("Loading Home Page Data..."),currentUser?(loadPromotions(),loadHomeUserTicker(),loadGames(),loadMyContests()):(elements.promotionSlider?.querySelector(".swiper-wrapper")&&(elements.promotionSlider.querySelector(".swiper-wrapper").innerHTML=""),elements.homeUserTicker&&(elements.homeUserTicker.innerHTML=""),elements.gamesList&&(elements.gamesList.innerHTML=""),elements.myContestsList&&(elements.myContestsList.innerHTML='<p class="text-secondary text-center">Login to view contests.</p>'))}async function loadPromotions(){console.log("Loading Promotions...");if(!elements.promotionSlider)return;const e=elements.promotionSlider.querySelector(".swiper-wrapper");if(!e)return;e.classList.add("placeholder-glow"),e.innerHTML='<div class="swiper-slide"><span class="placeholder" style="height: 100%; border-radius: 10px; display: block; width: 100%;"></span></div>';const t=ref(db,"promotions");try{const o=await get(t),s=o.val()||{},n=Object.values(s).filter(e=>e.imageUrl);if(console.log(`Found ${n.length} active promotions.`),removePlaceholders(elements.promotionSlider),e.innerHTML="",n.length>0){elements.promotionSlider.style.display="block",n.forEach(t=>{const o=document.createElement("div");o.className="swiper-slide",o.innerHTML=t.link?`<a href="${t.link}" target="_blank"><img src="${t.imageUrl}" alt="Promo"></a>`:`<img src="${t.imageUrl}" alt="Promo">`,e.appendChild(o)}),swiperInstance&&swiperInstance.destroy(!0,!0),swiperInstance=new Swiper(elements.promotionSlider,{loop:n.length>1,autoplay:{delay:3500,disableOnInteraction:!1},pagination:{el:".swiper-pagination",clickable:!0},slidesPerView:1})}else elements.promotionSlider.style.display="none"}catch(a){console.error("Promo load failed:",a),removePlaceholders(elements.promotionSlider),e.innerHTML='<p class="text-danger text-center small p-3">Could not load promotions.</p>',elements.promotionSlider.style.display="block"}}
        
        async function loadHomeUserTicker() {
            if(!elements.homeUserTicker) return;
            console.log("Loading Home User Ticker...");
            try {
                const usersRef = query(ref(db, "users"), limitToLast(20));
                const snapshot = await get(usersRef);
                elements.homeUserTicker.innerHTML = "";
                
                if (snapshot.exists()) {
                    const users = [];
                    snapshot.forEach(child => {
                        const u = child.val();
                        if(u.displayName) users.push(u);
                    });
                    
                    users.reverse();
                    
                    users.forEach(user => {
                        const displayName = user.displayName;
                        const photoURL = user.photoURL || `https://ui-avatars.com/api/?name=${encodeURIComponent(displayName)}&background=0F172A&color=FACC15&bold=true`;
                        
                        const tickerItem = document.createElement("div");
                        tickerItem.className = "ticker-item";
                        tickerItem.innerHTML = `
                            <img src="${photoURL}" alt="${displayName}" class="ticker-avatar">
                            <span class="ticker-name">${displayName.split(' ')[0]}</span>
                        `;
                        elements.homeUserTicker.appendChild(tickerItem);
                    });
                } else {
                    elements.homeUserTicker.innerHTML = "<small class='text-secondary ps-2'>No active players.</small>";
                }
            } catch (error) {
                console.error("Failed to load ticker:", error);
                elements.homeUserTicker.innerHTML = "<small class='text-danger ps-2'>Error loading players.</small>";
            }
        }

        async function loadGames(){console.log("Loading Games...");if(!elements.gamesList)return;elements.gamesList.classList.add("placeholder-glow"),elements.gamesList.innerHTML='<div class="col-6"><div class="game-card custom-card"><span class="placeholder d-block" style="height: 130px;"></span><span class="placeholder d-block mt-2 col-8 mx-auto" style="height: 20px;"></span></div></div> <div class="col-6"><div class="game-card custom-card"><span class="placeholder d-block" style="height: 130px;"></span><span class="placeholder d-block mt-2 col-8 mx-auto" style="height: 20px;"></span></div></div>';const e=ref(db,"games");try{const t=await get(e),o=t.val()||{},s=Object.entries(o).filter(([,e])=>e.imageUrl&&e.name).sort(([,e],[,t])=>(e.order||0)-(t.order||0));if(console.log(`Found ${s.length} active games.`),removePlaceholders(elements.gamesList),elements.gamesList.innerHTML="",s.length>0){appSettings.games||(appSettings.games={}),s.forEach(([e,t])=>{appSettings.games[e]={name:t.name,imageUrl:t.imageUrl};const o=document.createElement("div");o.className="col-6",o.innerHTML=`<div class="game-card custom-card" data-game-id="${e}" data-game-name="${t.name}"><img src="${t.imageUrl}" alt="${t.name}"><span>${t.name}</span></div>`,o.querySelector(".game-card").addEventListener("click",()=>{currentTournamentGameId=e,loadTournamentsForGame(e,t.name)}),elements.gamesList.appendChild(o)})}else elements.gamesList.innerHTML='<p class="text-secondary text-center col-12">No games available.</p>'}catch(n){console.error("Games load failed:",n),removePlaceholders(elements.gamesList),elements.gamesList.innerHTML='<p class="text-danger text-center col-12">Could not load games.</p>'}}function loadTournamentsForGame(e,t){console.log(`Loading tournaments for game: ${t} (ID: ${e})`),elements.tournamentsSection&&(currentTournamentGameId=e,elements.tournamentTabs.forEach(e=>e.classList.remove("active")),querySel('.tournament-tabs .tab-item[data-status="upcoming"]')?.classList.add("active"),showSection("tournaments-section"),filterTournaments(e,"upcoming"))}async function filterTournaments(e,t){console.log(`Filtering tournaments for game ${e} with status ${t}`);if(!elements.tournamentsListContainer)return;elements.tournamentsListContainer.innerHTML="",elements.tournamentsListContainer.classList.add("placeholder-glow"),elements.tournamentsListContainer.innerHTML='<div class="tournament-card placeholder-glow mb-3"><span class="placeholder col-6"></span><span class="placeholder col-12 mt-2"></span><span class="placeholder col-10 mt-2"></span><div class="d-flex justify-content-between mt-3"><span class="placeholder col-4 h-30"></span><span class="placeholder col-4 h-30"></span></div></div>',elements.noTournamentsMessage.style.display="none";try{const o=query(ref(db,"tournaments"),orderByChild("gameId"),equalTo(e)),s=await get(o),n=s.val()||{},a=Object.entries(n).filter(([,e])=>e.status===t).sort(([,e],[,t])=>(e.startTime||0)-(t.startTime||0));if(console.log(`Found ${a.length} tournaments matching criteria.`),removePlaceholders(elements.tournamentsListContainer),elements.tournamentsListContainer.innerHTML="",a.length>0)a.forEach(([e,t])=>{const o=createTournamentCardElement(e,t);elements.tournamentsListContainer.appendChild(o)});else elements.noTournamentsMessage.style.display="block",elements.noTournamentsMessage.textContent=`No ${t} tournaments found.`}catch(r){console.error(`Tournaments filter failed (${t}):`,r),removePlaceholders(elements.tournamentsListContainer),elements.tournamentsListContainer.innerHTML='<p class="text-danger tc mt-4">Could not load tournaments.</p>',elements.noTournamentsMessage.style.display="none"}}
        function createTournamentCardElement(e,t){const o=document.createElement("div");o.className="tournament-card",o.dataset.tournamentId=e;const s=t.entryFee||0,n=t.perKillPrize||0,a=t.prizePool||0,r=t.startTime?new Date(t.startTime):null,l=r?r.toLocaleString([],"short"=={dateStyle:"short",timeStyle:"short"}):"TBA",c=t.registeredPlayers||{},i=Object.keys(c).length,u=t.maxPlayers||0,d=u>0?Math.max(0,u-i):1/0,m=u>0&&d<=0,p=currentUser&&userProfile?.joinedTournaments?.[e],f=!p&&!m&&"upcoming"===t.status;let h=t.status?.toUpperCase()||"N/A";"upcoming"===t.status&&r?h=getTimeRemaining(t.startTime):"ongoing"===t.status?h="LIVE":"completed"!==t.status&&"result"!==t.status||(h="ENDED");let g="Unlimited Spots",w=0;u>0&&(g=`<span class="${d<=5?"text-danger":"text-accent"}">${d}</span> Spots Left (${i}/${u})`,w=Math.min(100,i/u*100));let y="",b="";if(p)y='<button class="btn btn-custom btn-sm btn-joined" disabled><i class="bi bi-check-circle-fill"></i> Joined</button>',("ongoing"===t.status||"upcoming"===t.status&&t.showIdPass&&r&&Date.now()>r.getTime()-9e5)&&(b=`<button class="btn btn-custom btn-idpass w-100 mt-2 btn-sm" data-tournament-id="${e}"><i class="bi bi-key-fill"></i> View ID & Pass</button>`);else if(f)y=`<button class="btn btn-custom btn-sm btn-custom-accent btn-join" data-tournament-id="${e}" data-fee="${s}">à§³${s} Join <i class="bi bi-arrow-right-short"></i></button>`;else{let v="upcoming"!==t.status?t.status?.toUpperCase():m?"Full":"Closed";y=`<button class="btn btn-custom btn-sm btn-disabled" disabled>${v||"N/A"}</button>`}const contentHtml=`<div class="tournament-card-header"><div class="tournament-card-tags">${t.mode?`<span>${t.mode}</span>`:""}${t.map?`<span>${t.map}</span>`:""}${t.tags?Array.isArray(t.tags)?t.tags.map(e=>`<span>${e}</span>`).join(""):Object.values(t.tags).map(e=>`<span>${e}</span>`).join(""):""}</div><div class="tournament-card-timer">${h}</div></div><h3 class="tournament-card-title">${t.icon?`<i class="${t.icon}"></i>`:'<i class="bi bi-joystick text-accent"></i>'} ${t.name||"Tournament"}</h3><p class="small text-secondary mb-2"><i class="bi bi-calendar-event"></i> ${l}</p><div class="tournament-card-info"><div class="info-item"><span>Prize Pool</span><strong><i class="bi bi-trophy-fill text-accent prize-icon"></i> à§³${a}</strong></div><div class="info-item"><span>Per Kill</span><strong>à§³${n}</strong></div><div class="info-item"><span>Entry Fee</span><strong class="${s>0?"text-info":""}">${s>0?`à§³${s}`:"Free"}</strong></div></div><div class="tournament-card-spots">${g}${u>0?`<div class="progress mt-1" style="height: 6px;"><div class="progress-bar bg-warning" role="progressbar" style="width: ${w}%"></div></div>`:""}</div><div class="tournament-card-actions"><button class="btn btn-custom btn-custom-secondary btn-sm btn-details" data-tournament-id="${e}">Details</button>${y}</div>${b}`;let bannerImageUrl=t.imageUrl;if(!bannerImageUrl&&t.gameId&&appSettings.games?.[t.gameId]?.imageUrl){bannerImageUrl=appSettings.games[t.gameId].imageUrl}if(bannerImageUrl){o.style.padding="0";o.innerHTML=`<img src="${bannerImageUrl}" alt="${t.name||"Tournament Banner"}" style="width: 100%; height: 160px; object-fit: cover; display: block;"><div class="tournament-card-content" style="padding: 15px;">${contentHtml}</div>`}else{o.innerHTML=contentHtml}o.querySelector(".btn-join")?.addEventListener("click",handleJoinTournamentClick),o.querySelector(".btn-details")?.addEventListener("click",handleMatchDetailsClick),o.querySelector(".btn-idpass")?.addEventListener("click",handleIdPasswordClick);return o}
        async function loadMyContests(){console.log("Loading My Contests...");if(!currentUser||!elements.myContestsList)return elements.myContestsList&&removePlaceholders(elements.myContestsList),elements.myContestsList&&(elements.myContestsList.innerHTML=""),void(elements.noContestsMessage&&(elements.noContestsMessage.style.display="block"));const e=Object.keys(userProfile.joinedTournaments||{});if(elements.myContestsList.classList.add("placeholder-glow"),elements.myContestsList.innerHTML='<div class="tournament-card placeholder-glow mb-3"><span class="placeholder col-6"></span><span class="placeholder col-12 mt-2"></span><span class="placeholder col-10 mt-2"></span><div class="d-flex justify-content-between mt-3"><span class="placeholder col-4 h-30"></span><span class="placeholder col-4 h-30"></span></div></div>',elements.noContestsMessage&&(elements.noContestsMessage.style.display="none"),0===e.length)return removePlaceholders(elements.myContestsList),elements.myContestsList.innerHTML="",elements.noContestsMessage&&(elements.noContestsMessage.style.display="block"),void console.log("No joined contests found for user.");console.log(`Found ${e.length} joined contest IDs.`);try{const t=e.map(e=>get(ref(db,`tournaments/${e}`))),o=await Promise.all(t);removePlaceholders(elements.myContestsList),elements.myContestsList.innerHTML="";const s=[];o.forEach((t,o)=>{if(t.exists()){const n=t.val();("upcoming"===n.status||"ongoing"===n.status)&&s.push({startTime:n.startTime||0,card:createTournamentCardElement(e[o],n)})}else console.warn(`Joined tournament ${e[o]} not found in tournaments node.`)}),s.sort((e,t)=>e.startTime-t.startTime),s.length>0?s.forEach(e=>elements.myContestsList.appendChild(e.card)):elements.noContestsMessage&&(elements.noContestsMessage.style.display="block",elements.noContestsMessage.textContent="No upcoming/ongoing joined contests.")}catch(n){console.error("My contests load failed:",n),removePlaceholders(elements.myContestsList),elements.myContestsList.innerHTML='<p class="text-danger tc">Could not load contests.</p>'}}function loadWalletData(){console.log("Loading Wallet Data..."),currentUser&&loadRecentTransactions()}function loadProfileData(){console.log("Loading Profile Data..."),currentUser&&userProfile?.displayName&&(removePlaceholders(elements.profileName?.closest(".placeholder-glow")),removePlaceholders(elements.profileEmail?.closest(".placeholder-glow")),removePlaceholders(elements.profileTotalMatches?.closest(".placeholder-glow")),removePlaceholders(elements.profileWonMatches?.closest(".placeholder-glow")),removePlaceholders(elements.profileTotalEarnings?.closest(".placeholder-glow")))}async function recordTransaction(e,t,o,s,n={}){if(!e)return;const a=ref(db,`transactions/${e}`),r={type:t,amount:o,description:s,timestamp:Date.now(),...n};try{await push(a,r),console.log(`Transaction recorded: ${t}, Amount: ${o}`)}catch(l){console.error("Transaction record failed:",l)}}async function loadRecentTransactions(){console.log("Loading Recent Transactions...");if(!currentUser||!elements.recentTransactionsList)return;elements.recentTransactionsList.innerHTML="",elements.recentTransactionsList.classList.add("placeholder-glow");for(let e=0;e<3;e++)elements.recentTransactionsList.innerHTML+='<div class="custom-card p-2 mb-2 placeholder-glow"><div class="d-flex justify-content-between"><span class="placeholder col-5 h-16"></span><span class="placeholder col-3 h-16"></span></div><div class="small text-secondary mt-1"><span class="placeholder col-6 h-14"></span></div></div>';elements.noTransactionsMessage&&(elements.noTransactionsMessage.style.display="block",elements.noTransactionsMessage.textContent="Loading transactions...");try{const e=query(ref(db,`transactions/${currentUser.uid}`),limitToLast(5)),t=await get(e),o=t.val()||{},s=Object.values(o).sort((e,t)=>(t.timestamp||0)-(e.timestamp||0));if(console.log(`Found ${s.length} recent transactions.`),removePlaceholders(elements.recentTransactionsList),elements.recentTransactionsList.innerHTML="",s.length>0){elements.noTransactionsMessage&&(elements.noTransactionsMessage.style.display="none"),s.forEach(e=>{const t=document.createElement("div");t.className="custom-card p-2 mb-2 d-flex justify-content-between align-items-center";const o=e.amount>0,s=`${o?"+":""}à§³${Math.abs(e.amount||0).toFixed(2)}`,n=e.timestamp?new Date(e.timestamp).toLocaleString([],"short"=={dateStyle:"short",timeStyle:"short"}):"N/A";t.innerHTML=`<div><div class="small fw-bold">${e.description||e.type||"Txn"}</div><div class="small text-secondary">${n}</div></div><div class="fw-bold ${o?"text-success":"text-danger"}">${s}</div>`,elements.recentTransactionsList.appendChild(t)})}else elements.noTransactionsMessage&&(elements.noTransactionsMessage.style.display="block",elements.noTransactionsMessage.textContent="No recent transactions.")}catch(n){console.error("Transactions load failed:",n),removePlaceholders(elements.recentTransactionsList),elements.recentTransactionsList.innerHTML='<p class="text-danger tc">Could not load transactions.</p>',elements.noTransactionsMessage&&(elements.noTransactionsMessage.style.display="none")}}
        
        function handleJoinTournamentClick(e) { if (!currentUser) { alert("Login to join."); return showSection("login-section"); } const targetButton = e.currentTarget; const tournamentId = targetButton.dataset.tournamentId; const fee = parseFloat(targetButton.dataset.fee || 0); if (!tournamentId || !elements.joinConfirmModalInstance) return; const confirmBtn = elements.confirmJoinBtnEl; confirmBtn.dataset.tournamentId = tournamentId; confirmBtn.dataset.fee = fee; elements.joinConfirmTextEl.innerHTML = `Are you sure you want to join for <strong>à§³${fee.toFixed(2)}</strong>? <br> Please confirm your in-game details below.`; elements.joinGameIdInputEl.value = userProfile.inGameId || ""; elements.joinFullNameInputEl.value = userProfile.displayName || ""; clearStatusMessage(elements.joinStatusMessageEl); confirmBtn.disabled = false; confirmBtn.innerHTML = "Confirm Join"; elements.joinConfirmModalInstance.show(); }
        async function processTournamentJoin() { if (!currentUser) return; const confirmBtn = elements.confirmJoinBtnEl; const tournamentId = confirmBtn.dataset.tournamentId; const fee = parseFloat(confirmBtn.dataset.fee || 0); const loaderHtml = '<div class="loader" style="width:16px;height:16px;"></div>'; const gameId = elements.joinGameIdInputEl.value.trim(); const fullName = elements.joinFullNameInputEl.value.trim(); if (!gameId || !fullName) { showStatusMessage(elements.joinStatusMessageEl, "Please enter your Game ID and Full Name.", "warning"); return; } confirmBtn.disabled = true; confirmBtn.innerHTML = `${loaderHtml} Joining...`; clearStatusMessage(elements.joinStatusMessageEl); const userRef = ref(db, `users/${currentUser.uid}`); const tournamentRef = ref(db, `tournaments/${tournamentId}`); let tournamentData = null; let balanceTx = null; try { balanceTx = await runTransaction(userRef, (profile) => { if (!profile) throw new Error("User profile missing."); if (profile.joinedTournaments?.[tournamentId]) return; const currentBonus = profile.bonusCash || 0; const currentWinnings = profile.winningCash || 0; if ((currentBonus + currentWinnings) < fee) throw new Error("Insufficient total balance."); let remainingFee = fee; const bonusToUse = Math.min(currentBonus, remainingFee); profile.bonusCash -= bonusToUse; remainingFee -= bonusToUse; if (remainingFee > 0) { profile.winningCash -= remainingFee; } if (!profile.joinedTournaments) profile.joinedTournaments = {}; profile.joinedTournaments[tournamentId] = true; profile.totalMatches = (profile.totalMatches || 0) + 1; return profile; }); if (!balanceTx.committed && userProfile?.joinedTournaments?.[tournamentId]) { throw new Error("Already joined this tournament."); } if (!balanceTx.committed) { throw new Error("Join transaction failed. Not enough balance or data mismatch."); } console.log("Balance and stats transaction successful."); const tourneySnapshot = await get(tournamentRef); if (!tourneySnapshot.exists()) throw new Error("Tournament not found after transaction."); tournamentData = tourneySnapshot.val(); if (tournamentData.status !== 'upcoming') throw new Error("Tournament is no longer available to join."); const playerCount = tournamentData.registeredPlayers ? Object.keys(tournamentData.registeredPlayers).length : 0; if (tournamentData.maxPlayers > 0 && playerCount >= tournamentData.maxPlayers) throw new Error("Tournament is full."); const updates = {}; updates[`tournaments/${tournamentId}/registeredPlayers/${currentUser.uid}`] = { joinedAt: serverTimestamp(), inGameId: gameId, inGameName: fullName, userEmail: currentUser.email }; if (!userProfile.inGameId || userProfile.inGameId !== gameId) { updates[`users/${currentUser.uid}/inGameId`] = gameId; } await update(ref(db), updates); console.log("Successfully updated tournament registered players."); await recordTransaction(currentUser.uid, 'tournament_join', -fee, `Joined: ${tournamentData.name || "Tournament"}`, { tournamentId: tournamentId }); showStatusMessage(elements.joinStatusMessageEl, "Successfully Joined!", "success", false); setTimeout(() => { elements.joinConfirmModalInstance.hide(); }, 1500); const tournamentCard = document.querySelector(`.tournament-card[data-tournament-id="${tournamentId}"]`); if (tournamentCard) { const latestTourneyData = (await get(tournamentRef)).val(); if(latestTourneyData) tournamentCard.parentNode.replaceChild(createTournamentCardElement(tournamentId, latestTourneyData), tournamentCard); } else if(currentSectionId === 'tournaments-section' && currentTournamentGameId) { const activeTab = querySel('.tournament-tabs .tab-item.active')?.dataset.status || 'upcoming'; filterTournaments(currentTournamentGameId, activeTab); } if (currentSectionId === 'home-section') loadMyContests(); if (currentSectionId === 'wallet-section') loadRecentTransactions(); } catch (error) { console.error("Join failed:", error); showStatusMessage(elements.joinStatusMessageEl, `Error: ${error.message}`, "danger"); if (balanceTx?.committed) { console.error("CRITICAL: Balance deducted but failed to update tournament! Attempting refund."); try { const refundTx = await runTransaction(userRef, (profile) => { if (profile) { profile.winningCash = (profile.winningCash || 0) + fee; if (profile.joinedTournaments?.[tournamentId]) { delete profile.joinedTournaments[tournamentId]; } profile.totalMatches = Math.max(0, (profile.totalMatches || 0) - 1); } return profile; }); if(refundTx.committed) { await recordTransaction(currentUser.uid, 'join_failed_refund', fee, `Refund Failed Join: ${tournamentData?.name || "Tournament"}`); showStatusMessage(elements.joinStatusMessageEl, `Error: ${error.message}. Your balance has been refunded.`, "danger", false); } else { console.error("CRITICAL: FAILED TO REFUND BALANCE!"); showStatusMessage(elements.joinStatusMessageEl, `Error: ${error.message}. CRITICAL: Failed to refund your balance! Contact support.`, "danger", false); } } catch (refundError) { console.error("CRITICAL: FAILED TO REFUND BALANCE!", refundError); showStatusMessage(elements.joinStatusMessageEl, `Error: ${error.message}. CRITICAL: Failed to refund your balance! Contact support.`, "danger", false); } } } finally { confirmBtn.disabled = false; confirmBtn.innerHTML = 'Confirm Join'; } }
        
        function handleWithdrawClick() { 
            if (currentUser && elements.withdrawModalInstance) { 
                const winningCash = userProfile.winningCash || 0;
                const bonusCash = userProfile.bonusCash || 0;
                const totalBalance = winningCash + bonusCash; 
                const minWithdraw = appSettings?.minWithdraw || 50; 
                elements.minWithdrawAmount.textContent = minWithdraw; 
                elements.withdrawModalBalance.textContent = `à§³${totalBalance.toFixed(2)}`; 
                elements.withdrawAmountInput.value = ""; 
                elements.withdrawAmountInput.min = minWithdraw; 
                elements.withdrawAccountInput.value = userProfile.withdrawNumber || ""; 
                const lastMethod = userProfile.lastWithdrawMethod || 'bKash'; 
                const radioToCheck = document.getElementById(`withdrawMethod${lastMethod}`); 
                if(radioToCheck) radioToCheck.checked = true; 
                clearStatusMessage(elements.withdrawStatusMessage); 
                elements.withdrawModalInstance.show(); 
            } 
        }

        async function submitWithdrawRequestHandler() { 
            if (!currentUser || !elements.withdrawModalInstance) return; 
            const selectedMethodEl = document.querySelector('input[name="withdrawPaymentMethod"]:checked'); 
            const amount = parseFloat(elements.withdrawAmountInput.value); 
            const accountNumber = elements.withdrawAccountInput.value.trim(); 
            const winningCash = userProfile.winningCash || 0;
            const bonusCash = userProfile.bonusCash || 0;
            const totalBalance = winningCash + bonusCash; 
            const minWithdraw = appSettings?.minWithdraw || 50; 
            
            clearStatusMessage(elements.withdrawStatusMessage); 
            if (!selectedMethodEl) return showStatusMessage(elements.withdrawStatusMessage, "Please select a payment method.", "warning"); 
            if (!accountNumber) return showStatusMessage(elements.withdrawStatusMessage, "Please enter your account number.", "warning"); 
            if (isNaN(amount) || amount <= 0) return showStatusMessage(elements.withdrawStatusMessage, "Please enter a valid amount.", "warning"); 
            if (amount < minWithdraw) return showStatusMessage(elements.withdrawStatusMessage, `Minimum withdrawal amount is à§³${minWithdraw}.`, "warning"); 
            if (amount > totalBalance) return showStatusMessage(elements.withdrawStatusMessage, "Insufficient total balance.", "warning"); 
            
            const methodName = selectedMethodEl.value; 
            const loaderHtml = '<div class="loader" style="width:16px;height:16px;"></div>'; 
            elements.submitWithdrawRequestBtn.disabled = true; 
            elements.submitWithdrawRequestBtn.innerHTML = `${loaderHtml} Sending...`; 
            
            let balanceDeducted = false; 
            try { 
                const userRef = ref(db, `users/${currentUser.uid}`); 
                const balanceTx = await runTransaction(userRef, (profile) => { 
                    if (profile) {
                        const currentWinnings = profile.winningCash || 0;
                        const currentBonus = profile.bonusCash || 0;
                        if ((currentWinnings + currentBonus) < amount) {
                             throw new Error("Insufficient total balance (Tx).");
                        }
                        let remainingAmount = amount;
                        const winningsToUse = Math.min(currentWinnings, remainingAmount);
                        profile.winningCash -= winningsToUse;
                        remainingAmount -= winningsToUse;
                        
                        if (remainingAmount > 0) {
                            profile.bonusCash -= remainingAmount;
                        }
                        return profile; 
                    } 
                    throw new Error("Profile missing (Tx)."); 
                }); 
                if (!balanceTx.committed) throw new Error("Failed to update balance. Please try again."); 
                balanceDeducted = true; 
                console.log("Balance deducted successfully."); 
                
                const profileUpdates = { withdrawNumber: accountNumber, lastWithdrawMethod: methodName }; 
                await update(userRef, profileUpdates); 
                const withdrawalsRef = ref(db, "withdrawals"); 
                const requestData = { userId: currentUser.uid, userName: userProfile.displayName || currentUser.email, amount: amount, methodDetails: { methodName: methodName, accountInfo: accountNumber }, status: "pending", requestTimestamp: serverTimestamp(), userEmail: currentUser.email || "N/A" }; 
                const newRequest = await push(withdrawalsRef, requestData); 
                console.log("Withdrawal request created:", newRequest.key); 
                await recordTransaction(currentUser.uid, 'withdraw_request', -amount, `Withdrawal to ${methodName}: ${accountNumber}`, { withdrawalId: newRequest.key }); 
                showStatusMessage(elements.withdrawStatusMessage, "Request submitted successfully!", "success", false); 
                setTimeout(() => { elements.withdrawModalInstance.hide(); }, 2500); 
                if (currentSectionId === 'wallet-section') loadRecentTransactions(); 
            } catch (error) { 
                console.error("Withdraw error:", error); 
                showStatusMessage(elements.withdrawStatusMessage, `Error: ${error.message}`, "danger"); 
                if (balanceDeducted) { 
                    console.warn("Attempting to refund balance due to withdrawal request failure..."); 
                    const userRef = ref(db, `users/${currentUser.uid}`); 
                    try { 
                        await runTransaction(userRef, (profile) => { if (profile) { profile.winningCash = (profile.winningCash || 0) + amount; } return profile; }); 
                        await recordTransaction(currentUser.uid, 'withdraw_failed_refund', amount, "Refund for Failed Withdrawal"); 
                        console.log("Refund successful."); 
                        showStatusMessage(elements.withdrawStatusMessage, `Error: ${error.message}. Your amount has been refunded.`, "danger"); 
                    } catch (refundError) { 
                        console.error("CRITICAL: FAILED TO REFUND BALANCE!", refundError); 
                        showStatusMessage(elements.withdrawStatusMessage, `Error: ${error.message}. CRITICAL: Failed to refund amount! Contact support immediately.`, "danger", false); 
                    } 
                } 
            } finally { 
                elements.submitWithdrawRequestBtn.disabled = false; 
                elements.submitWithdrawRequestBtn.innerHTML = "Submit Request"; 
            } 
        }

        async function handleMatchDetailsClick(e) { console.log("Match Details Clicked"); if (!elements.matchDetailsModalInstance) return; const tournamentId = e.currentTarget.dataset.tournamentId; if (!tournamentId) return; elements.matchDetailsModalTitle.textContent = "Loading..."; elements.matchDetailsModalBody.innerHTML = '<div class="d-flex justify-content-center p-5"><div class="loader"></div></div>'; elements.matchDetailsModalInstance.show(); try { const tournamentRef = ref(db, `tournaments/${tournamentId}`); const snapshot = await get(tournamentRef); if (snapshot.exists()) { const tournamentData = snapshot.val(); const gameName = appSettings.games?.[tournamentData.gameId]?.name || tournamentData.gameId || "N/A"; const startTime = tournamentData.startTime ? new Date(tournamentData.startTime).toLocaleString([], { dateStyle: 'medium', timeStyle: 'short' }) : "TBA"; const mode = tournamentData.mode || "N/A"; const map = tournamentData.map || "N/A"; let prizeDistributionHtml = ''; if (tournamentData.prizeDistribution) { let prizeText = ''; if (typeof tournamentData.prizeDistribution === 'object') { prizeText = Object.entries(tournamentData.prizeDistribution).map(([rank, prize]) => `Rank ${rank}: à§³${prize}`).join('\n'); } else { prizeText = String(tournamentData.prizeDistribution).replace(/\\n/g, '\n'); } prizeDistributionHtml = `<h5>Prize Distribution:</h5><pre>${prizeText}</pre>`; } const rules = (tournamentData.description || "Standard rules apply.").replace(/\n/g, '<br>'); elements.matchDetailsModalTitle.textContent = tournamentData.name || "Match Details"; elements.matchDetailsModalBody.innerHTML = ` <p><strong>Game:</strong> ${gameName}</p> <p><strong>Mode:</strong> ${mode}</p> <p><strong>Map:</strong> ${map}</p> <p><strong>Starts:</strong> ${startTime}</p> <hr> <p><strong>Entry:</strong> ${tournamentData.entryFee > 0 ? `à§³${tournamentData.entryFee}` : "Free"}</p> <p><strong>Prize:</strong> à§³${tournamentData.prizePool || 0}</p> <p><strong>Per Kill:</strong> à§³${tournamentData.perKillPrize || 0}</p> <p><strong>Max Players:</strong> ${tournamentData.maxPlayers > 0 ? tournamentData.maxPlayers : "Unlimited"}</p> <hr> <h5>Rules:</h5> <div style="white-space: pre-wrap; line-height: 1.6;">${rules}</div> ${prizeDistributionHtml} `; } else { elements.matchDetailsModalBody.innerHTML = '<p class="text-danger">Details not found.</p>'; } } catch (error) { console.error("Details load failed:", error); elements.matchDetailsModalBody.innerHTML = '<p class="text-danger">Error loading details.</p>'; } }
        async function handleIdPasswordClick(e){if(!elements.idPasswordModalInstance)return;const t=e.currentTarget.dataset.tournamentId;if(!t)return;if(console.log("--- Checking ID/Pass ---"),console.log("Tournament ID (tId):",t),console.log("Current User UID:",currentUser?.uid),!currentUser||!userProfile?.joinedTournaments?.[t])return console.warn("Client-side check failed: User not logged in or tId not found in userProfile.joinedTournaments"),void alert("Join the tournament first or refresh the page.");elements.roomIdDisplay.innerHTML='<span class="placeholder col-6"></span>',elements.roomPasswordDisplay.innerHTML='<span class="placeholder col-6"></span>',elements.idPasswordModalInstance.show();try{const o=ref(db,`tournaments/${t}`);console.log("Fetching from path:",`tournaments/${t}`);const s=await get(o);if(console.log("Snapshot exists?",s.exists(),"Snapshot value:",s.val()),removePlaceholders(elements.roomIdDisplay.closest(".placeholder-glow")),removePlaceholders(elements.roomPasswordDisplay.closest(".placeholder-glow")),s.exists()){const n=s.val();n.showIdPass?(elements.roomIdDisplay.textContent=n.roomId||"Not updated yet",elements.roomPasswordDisplay.textContent=n.roomPassword||"Not updated yet"):(elements.roomIdDisplay.textContent="Hidden by Admin",elements.roomPasswordDisplay.textContent="Hidden by Admin")}else elements.roomIdDisplay.textContent="Not Found",elements.roomPasswordDisplay.textContent="Not Found"}catch(a){console.error("ID/Pass fetch error:",a),removePlaceholders(elements.roomIdDisplay.closest(".placeholder-glow")),removePlaceholders(elements.roomPasswordDisplay.closest(".placeholder-glow")),elements.roomIdDisplay.textContent="Error",elements.roomPasswordDisplay.textContent="Error",alert("Error loading ID/Password. Check permissions or network.")}}async function handlePolicyClick(e){console.log("Policy link clicked");if(!elements.policyModalInstance)return void console.error("Policy modal instance not found");e.preventDefault();const t=e.currentTarget,o=t.dataset.policy;if(console.log("Policy type requested:",o),!o)return;let s="",n='<div class="d-flex justify-content-center p-5"><div class="loader"></div></div>';switch(elements.policyModalBody.innerHTML=n,o){case"privacy":s="Privacy Policy",n=appSettings.policyPrivacy||"Content not available.";break;case"terms":s="Terms and Conditions",n=appSettings.policyTerms||"Content not available.";break;case"refund":s="Refund and Cancellation",n=appSettings.policyRefund||"Content not available.";break;case"fairPlay":s="Fair Play Policy",n=appSettings.policyFairPlay||"Content not available.";break;case"refer":if(s="Refer & Earn",!currentUser)return void alert("Login to view referral.");const a=userProfile.referralCode||"N/A",r=appSettings?.referralBonus||0,l=appSettings?.referralDescription||`Get à§³${r} when your friend joins using your code.`;n=`<div class="text-center"><h4>Refer Friends!</h4><p class="text-secondary">Share code & earn!</p><div class="my-4 p-3" style="background: var(--primary-bg); border-radius: 8px;"><p class="small text-secondary mb-1">Your Code:</p><h3 class="text-accent referral-code" id="referralCodeDisplay">${a}</h3><div class="mt-3"><button class="btn btn-sm btn-custom btn-custom-secondary me-2 copy-btn" data-target="#referralCodeDisplay"><i class="bi bi-clipboard"></i> Copy</button><button class="btn btn-sm btn-custom btn-custom-secondary" id="shareReferralBtn"><i class="bi bi-share-fill"></i> Share</button></div></div><p class="mt-3 small text-secondary">${l}</p></div>`;break;default:s="Info",console.warn("Unknown policy:",o),n="<p>Content unavailable.</p>"}elements.policyModalTitle.textContent=s,"string"==typeof n&&"refer"!==o?elements.policyModalBody.innerHTML=n.replace(/\n/g,"<br>"):elements.policyModalBody.innerHTML=n,console.log("Showing policy modal for:",o),elements.policyModalInstance.show()}function setupRealtimeListeners(e){if(e&&db&&currentUser){detachAllDbListeners(),console.log("Setting up realtime listener for User Profile:",e);const t=ref(db,`users/${e}`),o=onValue(t,s=>{currentUser&&currentUser.uid===e?s.exists()?(console.log("Realtime: User Profile Update Received"),userProfile=s.val(),populateUserInfo(currentUser,userProfile),"home-section"===currentSectionId&&loadMyContests(),"wallet-section"===currentSectionId&&loadRecentTransactions()):(console.warn("User data deleted (realtime) for:",e),alert("Account data missing or deleted. Logging out."),logoutUser()):(console.log("Realtime listener fired for a different user or logged-out state. Detaching."),off(t,"value",o))},e=>{console.error("Listener error (user profile):",e)});dbListeners.userProfile={path:`users/${e}`,func:o}}}function detachAllDbListeners(){console.log("Detaching listeners:",Object.keys(dbListeners));let e=0;for(const t in dbListeners)try{const{path:o,func:s}=dbListeners[t];o&&s?(off(ref(db,o),"value",s),e++):console.warn(`Listener object invalid for key: ${t}`)}catch(n){console.error(`Detach error ${t}:`,n)}dbListeners={},console.log(`Detached ${e} listeners.`)}async function checkSecurityRules(){console.log("Checking security rules..."),currentUser?elements.securityWarning&&(elements.securityWarning.style.display="none"):console.log("Security rule check skipped for anonymous user (rely on console).")}
        function showRechargeStep(e){elements.rechargeStep1.style.display="none",elements.rechargeStep2.style.display="none",elements.rechargeStep3.style.display="none",clearStatusMessage(elements.rechargeStatusMessage),1===e?(elements.rechargeModalTitle.textContent="Recharge",elements.rechargeStep1.style.display="block"):2===e?(elements.rechargeModalTitle.textContent="Select Payment Method",elements.rechargeStep2.style.display="block"):3===e&&(elements.rechargeModalTitle.textContent="Complete Recharge",elements.rechargeStep3.style.display="block")}function handleAddAmountClick(){if(!currentUser)return alert("Please login to add amount."),void showSection("login-section");rechargeState={amount:0,method:""},elements.rechargeAmountInput.value="",elements.rechargeTxnIdInput.value="",elements.rechargeGameIdInput.value="";const e=document.querySelectorAll('input[name="paymentMethod"]');e.forEach(e=>{e.checked=!1});const totalBalance = (userProfile.winningCash || 0) + (userProfile.bonusCash || 0); elements.rechargeModalBalance.textContent=`à§³${totalBalance.toFixed(2)}`,showRechargeStep(1),elements.rechargeModalInstance.show()}async function submitRechargeRequest(){const e=elements.rechargeTxnIdInput.value.trim(),t=elements.rechargeGameIdInput.value.trim();if(!e||!t)return void showStatusMessage(elements.rechargeStatusMessage,"Please fill all fields.","warning");const loaderHtml='<div class="loader" style="width:16px;height:16px;"></div>';elements.rechargeSubmitBtn.disabled=!0,elements.rechargeSubmitBtn.innerHTML=`${loaderHtml} Submitting...`;const o={userId:currentUser.uid,userName:userProfile.displayName||currentUser.email,amount:rechargeState.amount,method:rechargeState.method,transactionId:e,playerGameId:t,status:"pending",timestamp:serverTimestamp()};try{const s=ref(db,"rechargeRequests");await push(s,o),showStatusMessage(elements.rechargeStatusMessage,"Request submitted! It will be reviewed by admin shortly.","success",!1),setTimeout(()=>{elements.rechargeModalInstance.hide()},3e3)}catch(n){console.error("Failed to submit recharge request:",n),showStatusMessage(elements.rechargeStatusMessage,"Failed to submit request. Please try again.","danger")}finally{elements.rechargeSubmitBtn.disabled=!1,elements.rechargeSubmitBtn.innerHTML="Submit"}}
        function loadNotifications(userId){if(!userId)return;const notificationsRef=ref(db,`notifications/${userId}`);dbListeners.notifications&&(off(ref(db,dbListeners.notifications.path),"value",dbListeners.notifications.func),delete dbListeners.notifications),console.log(`Setting up realtime listener for Notifications: notifications/${userId}`);const listenerFunc=onValue(notificationsRef,snapshot=>{if(!elements.notificationsList||!elements.notificationBadge)return;if(elements.notificationsList.innerHTML="",snapshot.exists()){const allNotifications=snapshot.val(),notificationEntries=Object.entries(allNotifications).sort(([,e],[,t])=>(t.timestamp||0)-(e.timestamp||0));let unreadCount=0;notificationEntries.forEach(([key,notification])=>{notification.isRead||unreadCount++;const notificationEl=document.createElement("a");notificationEl.href=notification.link||"#",notificationEl.className="list-group-item list-group-item-action",notificationEl.style.borderBottom=`1px solid var(--border-color)`,notificationEl.addEventListener("click",e=>{notification.link&&"#"!==notification.link||e.preventDefault(),elements.notificationsModalInstance.hide()});const timestamp=notification.timestamp?new Date(notification.timestamp).toLocaleString([],"short"=={dateStyle:"short",timeStyle:"short"}):"";notificationEl.innerHTML=`
                            <div class="d-flex w-100 justify-content-between align-items-center">
                                <h6 class="mb-1">${notification.isRead?"":'<i class="bi bi-circle-fill text-accent me-2" style="font-size: 0.5rem;"></i>'} ${notification.title||"Notification"}</h6>
                                <small class="text-secondary">${timestamp}</small>
                            </div>
                            <p class="mb-1 small text-secondary">${notification.message||""}</p>
                        `,elements.notificationsList.appendChild(notificationEl)}),unreadCount>0?(elements.notificationBadge.textContent=unreadCount>9?"9+":unreadCount,elements.notificationBadge.style.display="flex"):(elements.notificationBadge.style.display="none",elements.noNotificationsMessage.style.display="none")}else elements.notificationBadge.style.display="none",elements.notificationsList.innerHTML='<p class="text-secondary text-center p-4" id="noNotificationsMessageEl">No notifications yet.</p>'},error=>{console.error("Notification listener failed:",error)});dbListeners.notifications={path:`notifications/${userId}`,func:listenerFunc}}async function markNotificationsAsRead(){if(!currentUser)return;console.log("Marking notifications as read...");const e=ref(db,`notifications/${currentUser.uid}`),t=await get(e);if(t.exists()){const o={};t.forEach(e=>{e.val().isRead||(o[`${e.key}/isRead`]=!0)}),Object.keys(o).length>0&&(await update(e,o),console.log("Updated unread notifications."))}}
        async function loadLeaderboardData() {
            if (!currentUser) return;
            console.log("Loading Leaderboard Data...");
            elements.leaderboardList.classList.add("placeholder-glow");
            elements.leaderboardList.innerHTML = '';
            for (let i = 0; i < 5; i++) {
                elements.leaderboardList.innerHTML += `<div class="leaderboard-item"><span class="leaderboard-rank placeholder col-1"></span> <span class="leaderboard-avatar placeholder" style="width: 45px; height: 45px; border-radius: 50%;"></span><span class="leaderboard-name placeholder col-6"></span> <span class="leaderboard-winnings placeholder col-3"></span></div>`;
            }
            elements.noLeaderboardMessage.style.display = 'none';

            try {
                const usersRef = ref(db, 'users');
                const snapshot = await get(usersRef);

                removePlaceholders(elements.leaderboardList);
                elements.leaderboardList.innerHTML = '';

                if (snapshot.exists()) {
                    const users = [];
                    snapshot.forEach(childSnapshot => {
                        const user = childSnapshot.val();
                        const totalBalance = (user.winningCash || 0) + (user.bonusCash || 0);
                        if (totalBalance > 0 && user.displayName) {
                           users.push({...user, totalBalance});
                        }
                    });
                    
                    users.sort((a, b) => b.totalBalance - a.totalBalance); 
                    const topUsers = users.slice(0, 50);

                    if (topUsers.length > 0) {
                        elements.noLeaderboardMessage.style.display = 'none';
                        topUsers.forEach((user, index) => {
                            const rank = index + 1;
                            const displayName = user.displayName;
                            const photoURL = user.photoURL || `https://ui-avatars.com/api/?name=${encodeURIComponent(displayName)}&background=1E293B&color=E2E8F0`;
                            const itemEl = document.createElement('div');
                            itemEl.className = 'leaderboard-item';
                            itemEl.innerHTML = `
                                <span class="leaderboard-rank">${rank}</span>
                                <img src="${photoURL}" alt="${displayName}" class="leaderboard-avatar">
                                <span class="leaderboard-name">${displayName}</span>
                                <span class="leaderboard-winnings">à§³${user.totalBalance.toFixed(2)}</span>
                            `;
                            elements.leaderboardList.appendChild(itemEl);
                        });
                    } else {
                         elements.noLeaderboardMessage.style.display = 'block';
                    }

                } else {
                    elements.noLeaderboardMessage.style.display = 'block';
                }
            } catch (error) {
                console.error("Failed to load leaderboard:", error);
                removePlaceholders(elements.leaderboardList);
                elements.leaderboardList.innerHTML = `<p class="text-danger text-center">Could not load leaderboard.</p>`;
            }
        }
        async function loadUpdateFeedData() { if (!currentUser) return; console.log("Loading Update Feed..."); elements.updateFeed.classList.add("placeholder-glow"); elements.updateFeed.innerHTML = `<div class="update-post-card placeholder-glow"><div class="placeholder" style="width: 100%; height: 200px;"></div><div class="update-post-content"><h4 class="update-post-title placeholder col-8"></h4><p class="update-post-body placeholder col-12"></p></div></div>`; elements.noUpdatesMessage.style.display = 'none'; const updatesRef = ref(db, 'updates'); const updatesQuery = query(updatesRef, orderByChild('timestamp')); try { const snapshot = await get(updatesQuery); removePlaceholders(elements.updateFeed); elements.updateFeed.innerHTML = ''; if (snapshot.exists()) { const posts = []; snapshot.forEach(child => { posts.push({ id: child.key, ...child.val() }); }); posts.reverse(); posts.forEach(post => { const postEl = createUpdatePostElement(post); elements.updateFeed.appendChild(postEl); }); elements.noUpdatesMessage.style.display = 'none'; } else { elements.noUpdatesMessage.style.display = 'block'; } } catch (error) { console.error("Failed to load update feed:", error); elements.updateFeed.innerHTML = `<p class="text-danger text-center">Could not load updates.</p>`; } }
        function createUpdatePostElement(post) { const postCard = document.createElement('div'); postCard.className = 'update-post-card'; postCard.dataset.postId = post.id; const loves = post.loves || {}; const comments = post.comments || {}; const loveCount = Object.keys(loves).length; const commentCount = Object.keys(comments).length; const userHasLoved = currentUser && loves[currentUser.uid]; let imageHtml = ''; if (post.imageUrl) { imageHtml = `<img src="${post.imageUrl}" alt="Update Image" class="update-post-image">`; } postCard.innerHTML = ` ${imageHtml} <div class="update-post-content"> <h4 class="update-post-title">${post.title || ''}</h4> <p class="update-post-body">${post.body || ''}</p> </div> <div class="update-post-actions"> <button class="action-btn btn-love ${userHasLoved ? 'loved' : ''}"> <i class="bi ${userHasLoved ? 'bi-heart-fill' : 'bi-heart'}"></i> <span class="love-count">${loveCount}</span> </button> <button class="action-btn btn-comment"> <i class="bi bi-chat-square-text"></i> <span class="comment-count">${commentCount}</span> </button> </div> `; postCard.querySelector('.btn-love').addEventListener('click', () => toggleLove(post.id)); postCard.querySelector('.btn-comment').addEventListener('click', () => openCommentsModal(post.id)); return postCard; }
        async function openCommentsModal(postId) { if (!currentUser || !elements.commentsModalInstance) return; elements.sendCommentBtn.dataset.postId = postId; elements.commentsList.innerHTML = '<div class="d-flex justify-content-center p-3"><div class="loader"></div></div>'; elements.commentsModalInstance.show(); const commentsRef = ref(db, `updates/${postId}/comments`); try { const snapshot = await get(query(commentsRef, orderByChild('timestamp'))); elements.commentsList.innerHTML = ''; if (snapshot.exists()) { snapshot.forEach(commentSnap => { const commentData = commentSnap.val(); const commentEl = document.createElement('div'); commentEl.className = 'comment-item'; const timestamp = commentData.timestamp ? new Date(commentData.timestamp).toLocaleString([], { dateStyle: 'short', timeStyle: 'short' }) : ''; commentEl.innerHTML = ` <div class="comment-meta"> <strong>${commentData.name || 'User'}</strong> <small>${timestamp}</small> </div> <p class="comment-body">${commentData.text}</p> `; elements.commentsList.appendChild(commentEl); }); elements.commentsList.scrollTop = elements.commentsList.scrollHeight; } else { elements.commentsList.innerHTML = '<p class="text-center text-secondary">No comments yet. Be the first!</p>'; } } catch (error) { console.error("Error loading comments:", error); elements.commentsList.innerHTML = '<p class="text-center text-danger">Could not load comments.</p>'; } }
        async function sendComment() { if (!currentUser) return; const postId = elements.sendCommentBtn.dataset.postId; const text = elements.commentInput.value.trim(); if (!text || !postId) return; const commentData = { text: text, uid: currentUser.uid, name: userProfile.displayName || currentUser.email.split('@')[0], timestamp: serverTimestamp() }; const commentsRef = ref(db, `updates/${postId}/comments`); try { await push(commentsRef, commentData); elements.commentInput.value = ''; openCommentsModal(postId); const postCard = document.querySelector(`.update-post-card[data-post-id="${postId}"] .comment-count`); if(postCard) postCard.textContent = parseInt(postCard.textContent, 10) + 1; } catch (error) { console.error("Failed to send comment:", error); alert("Could not post comment. Please try again."); } }
        async function toggleLove(postId) { if (!currentUser) return; const postLovesRef = ref(db, `updates/${postId}/loves/${currentUser.uid}`); const postCard = document.querySelector(`.update-post-card[data-post-id="${postId}"]`); if (!postCard) return; const loveButton = postCard.querySelector('.btn-love'); const loveIcon = loveButton.querySelector('i'); const loveCountSpan = loveButton.querySelector('.love-count'); let currentCount = parseInt(loveCountSpan.textContent, 10); try { const snapshot = await get(postLovesRef); if (snapshot.exists()) { await set(postLovesRef, null); loveButton.classList.remove('loved'); loveIcon.className = 'bi bi-heart'; loveCountSpan.textContent = Math.max(0, currentCount - 1); } else { await set(postLovesRef, true); loveButton.classList.add('loved'); loveIcon.className = 'bi bi-heart-fill'; loveCountSpan.textContent = currentCount + 1; } } catch (error) { console.error("Failed to toggle love:", error); alert("Could not update reaction. Please try again."); } }

        function openLiveSupportChat() { if (!currentUser || !elements.liveSupportModalInstance) return; elements.liveSupportModalInstance.show(); elements.liveSupportMessages.innerHTML = '<div class="d-flex justify-content-center p-3"><div class="loader"></div></div>'; const chatPath = `liveSupportChats/${currentUser.uid}/messages`; const messagesRef = ref(db, chatPath); if (dbListeners.liveChat) { off(ref(db, dbListeners.liveChat.path), 'value', dbListeners.liveChat.func); } const listenerFunc = onValue(messagesRef, (snapshot) => { elements.liveSupportMessages.innerHTML = ''; if (snapshot.exists()) { snapshot.forEach(childSnapshot => { const message = childSnapshot.val(); renderChatMessage(message); }); } else { elements.liveSupportMessages.innerHTML = '<p class="text-center text-secondary small p-3">Welcome to live support! Type your question below to start a conversation.</p>'; } elements.liveSupportMessages.scrollTop = elements.liveSupportMessages.scrollHeight; }); dbListeners.liveChat = { path: chatPath, func: listenerFunc }; }
        function renderChatMessage(message) { if(!elements.liveSupportMessages) return; const msgDiv = document.createElement('div'); const bubbleDiv = document.createElement('div'); const metaDiv = document.createElement('div'); const sender = message.sender || 'user'; msgDiv.className = `chat-message ${sender}`; bubbleDiv.className = 'chat-bubble'; metaDiv.className = 'chat-bubble-meta'; bubbleDiv.textContent = message.text || ''; const timestamp = message.timestamp ? new Date(message.timestamp).toLocaleTimeString([], { hour: '2-digit', minute: '2-digit'}) : ''; metaDiv.textContent = sender === 'admin' ? `Admin â¢ ${timestamp}` : `You â¢ ${timestamp}`; bubbleDiv.appendChild(metaDiv); msgDiv.appendChild(bubbleDiv); elements.liveSupportMessages.appendChild(msgDiv); }
        async function sendLiveSupportMessage() { if (!currentUser) return; const text = elements.liveSupportInput.value.trim(); if (!text) return; const messageData = { text: text, sender: 'user', timestamp: serverTimestamp() }; elements.liveSupportInput.value = ''; elements.sendLiveSupportBtn.disabled = true; const messagesRef = ref(db, `liveSupportChats/${currentUser.uid}/messages`); try { await push(messagesRef, messageData); } catch (error) { console.error("Failed to send live support message:", error); alert("Message could not be sent. Please try again."); elements.liveSupportInput.value = text; } finally { elements.sendLiveSupportBtn.disabled = false; } }
        function toggleProfileNameEdit(isEditing) { clearStatusMessage(elements.profileNameStatusMessageEl); if(isEditing) { elements.profileNameDisplayContainer.style.display = 'none'; elements.editProfileNameContainerEl.style.display = 'flex'; elements.profileNameInputEl.value = userProfile.displayName || ''; elements.profileNameInputEl.focus(); } else { elements.profileNameDisplayContainer.style.display = 'flex'; elements.editProfileNameContainerEl.style.display = 'none'; } }
        async function saveProfileName() { if(!currentUser) return; const newName = elements.profileNameInputEl.value.trim(); if(!newName || newName.length < 3) { showStatusMessage(elements.profileNameStatusMessageEl, 'Name must be at least 3 characters.', 'warning'); return; } if(newName === userProfile.displayName) { toggleProfileNameEdit(false); return; } elements.saveProfileNameBtnEl.disabled = true; elements.saveProfileNameBtnEl.innerHTML = '<div class="loader" style="width:16px;height:16px;"></div>'; try { const userRef = ref(db, `users/${currentUser.uid}`); await update(userRef, { displayName: newName }); showStatusMessage(elements.profileNameStatusMessageEl, 'Name updated successfully!', 'success'); setTimeout(() => { toggleProfileNameEdit(false); }, 1500); } catch (error) { console.error("Failed to update name:", error); showStatusMessage(elements.profileNameStatusMessageEl, 'Failed to update name.', 'danger'); } finally { elements.saveProfileNameBtnEl.disabled = false; elements.saveProfileNameBtnEl.textContent = 'Save'; } }
        
        function handleContactSupportClick(e) { 
            e.preventDefault();
            const supportUrl = appSettings.supportUrl || appSettings.supportContact || appSettings.contactLink || appSettings.telegramUrl || appSettings.whatsappUrl;
            
            if (supportUrl && (supportUrl.startsWith('http') || supportUrl.startsWith('https'))) { 
                window.open(supportUrl, '_blank', 'noopener,noreferrer'); 
            } else { 
                console.log("Debug Support Info:", appSettings);
                alert("Support contact information is not available at the moment.\n(Admin needs to set a valid URL in Settings)"); 
            } 
        }

        // --- NEW: Functions to update UI from settings ---
        function updateTimeDashboard() {
            if (!elements.timeEl || !elements.dateEl || !elements.dayEl) return;
            const now = new Date();
            const timeString = now.toLocaleTimeString('en-US', { hour: '2-digit', minute: '2-digit', second: '2-digit', hour12: true });
            const dateString = now.toLocaleDateString('en-GB', { day: '2-digit', month: '2-digit', year: 'numeric' });
            const dayString = now.toLocaleDateString('en-US', { weekday: 'long' });

            elements.timeEl.textContent = timeString;
            elements.dateEl.textContent = dateString;
            elements.dayEl.textContent = dayString;
        }

        function updateMarquee() {
            if (appSettings.marqueeText && elements.marqueeText) {
                elements.marqueeText.textContent = appSettings.marqueeText;
                elements.marqueeContainer.style.display = 'block';
            } else if (elements.marqueeContainer) {
                elements.marqueeContainer.style.display = 'none';
            }
        }

        function populateSocialMediaModal() {
            if (!elements.socialIconsModalWrapperEl) return;
            elements.socialIconsModalWrapperEl.innerHTML = '';
            const socialLinks = {
                youtube: { url: appSettings.youtubeUrl, icon: 'fab fa-youtube', name: 'YouTube' },
                facebook: { url: appSettings.facebookUrl, icon: 'fab fa-facebook-f', name: 'Facebook' },
                telegram: { url: appSettings.telegramUrl, icon: 'fab fa-telegram-plane', name: 'Telegram' },
                tiktok: { url: appSettings.tiktokUrl, icon: 'fab fa-tiktok', name: 'TikTok' },
                whatsapp: { url: appSettings.whatsappUrl, icon: 'fab fa-whatsapp', name: 'WhatsApp' }
            };
            let hasLinks = false;
            for (const key in socialLinks) {
                if (socialLinks[key].url) {
                    hasLinks = true;
                    const link = document.createElement('a');
                    link.href = socialLinks[key].url;
                    link.className = 'social-icon'; 
                    link.target = '_blank';
                    link.rel = 'noopener noreferrer';
                    link.title = socialLinks[key].name;
                    link.innerHTML = `<i class="${socialLinks[key].icon}"></i>`;
                    elements.socialIconsModalWrapperEl.appendChild(link);
                }
            }
            if (!hasLinks) {
                elements.socialIconsModalWrapperEl.innerHTML = '<p class="text-secondary text-center w-100">No social media links have been set up by the admin yet.</p>';
            }
        }
        
        function updateHomeBanner() {
            if (!elements.homeBannerContainer) return;
            const { bannerImageUrl, bannerLinkUrl } = appSettings;
            if (bannerImageUrl) {
                elements.homeBannerContainer.innerHTML = `
                    <a href="${bannerLinkUrl || '#'}" target="_blank" rel="noopener noreferrer">
                        <img src="${bannerImageUrl}" alt="Special Promotion Banner">
                    </a>
                `;
                elements.homeBannerContainer.style.display = 'block';
            } else {
                elements.homeBannerContainer.style.display = 'none';
            }
        }

        async function claimPromoCode() {
            if (!currentUser) {
                elements.promoCodeModalInstance.hide();
                alert("You must be logged in to claim a promo code.");
                showSection('login-section');
                return;
            }

            const code = elements.promoCodeInputEl.value.trim().toUpperCase();
            if (!code) {
                showStatusMessage(elements.promoCodeStatusMessageEl, "Please enter a promo code.", "warning");
                return;
            }

            const claimBtn = elements.claimPromoCodeBtnEl;
            const loaderHtml = '<div class="loader" style="width:16px;height:16px;"></div>';
            claimBtn.disabled = true;
            claimBtn.innerHTML = `${loaderHtml} Claiming...`;
            clearStatusMessage(elements.promoCodeStatusMessageEl);

            try {
                // 1. Find the promo code in the database
                const promoRef = ref(db, 'promoCodes');
                const promoQuery = query(promoRef, orderByChild('code'), equalTo(code));
                const promoSnapshot = await get(promoQuery);

                if (!promoSnapshot.exists()) {
                    throw new Error("Invalid promo code.");
                }

                let promoData = null;
                let promoId = null;
                promoSnapshot.forEach(child => {
                    promoId = child.key;
                    promoData = child.val();
                });
                
                // 2. Check if user already claimed this code (using promoId for reliability)
                const userClaimsRef = ref(db, `users/${currentUser.uid}/claimedPromoCodes/${promoId}`);
                const userClaimSnapshot = await get(userClaimsRef);
                if (userClaimSnapshot.exists()) {
                    throw new Error("You have already used this promo code.");
                }

                // 3. Validate the promo code
                if (!promoData.isActive) {
                    throw new Error("This promo code is no longer active.");
                }
                if (promoData.expiryDate && Date.now() > promoData.expiryDate) {
                    throw new Error("This promo code has expired.");
                }
                if (promoData.maxUses > 0 && (promoData.uses || 0) >= promoData.maxUses) {
                    throw new Error("This promo code has reached its usage limit.");
                }

                const bonusAmount = promoData.bonusAmount || 0;
                if (bonusAmount <= 0) {
                    throw new Error("Invalid bonus amount for this code.");
                }

                // 4. Perform transaction to add bonus and mark as claimed
                const userRef = ref(db, `users/${currentUser.uid}`);
                const balanceTx = await runTransaction(userRef, (profile) => {
                    if (profile) {
                        if (profile.claimedPromoCodes?.[promoId]) {
                            return; // Abort transaction if already claimed
                        }
                        profile.bonusCash = (profile.bonusCash || 0) + bonusAmount;
                        if (!profile.claimedPromoCodes) {
                            profile.claimedPromoCodes = {};
                        }
                        profile.claimedPromoCodes[promoId] = true; // Mark by ID
                        return profile;
                    }
                    return profile; 
                });

                if (!balanceTx.committed) {
                    throw new Error("Could not claim code. It might have been claimed already. Please try again.");
                }

                // 5. Log the claim for admin panel
                const claimLogRef = ref(db, 'promoCodeClaims');
                await push(claimLogRef, {
                    promoCode: code,
                    promoId: promoId,
                    userId: currentUser.uid,
                    userEmail: currentUser.email,
                    userName: userProfile.displayName || 'N/A',
                    bonusAmount: bonusAmount,
                    claimedAt: serverTimestamp()
                });

                // 6. Update promo code usage count
                const currentPromoRef = ref(db, `promoCodes/${promoId}`);
                const promoUsesTx = await runTransaction(currentPromoRef, (promo) => {
                    if (promo) {
                        promo.uses = (promo.uses || 0) + 1;
                    }
                    return promo;
                });
                
                // 7. Record a user-facing transaction
                await recordTransaction(currentUser.uid, 'promo_code_claim', bonusAmount, `Claimed Promo: ${code}`);

                showStatusMessage(elements.promoCodeStatusMessageEl, `Success! à§³${bonusAmount} has been added to your bonus cash.`, "success", false);
                elements.promoCodeInputEl.value = '';
                setTimeout(() => {
                    elements.promoCodeModalInstance.hide();
                }, 2000);

            } catch (error) {
                console.error("Promo Code Claim Error:", error);
                showStatusMessage(elements.promoCodeStatusMessageEl, error.message, "danger");
            } finally {
                claimBtn.disabled = false;
                claimBtn.innerHTML = "Claim Reward";
            }
        }


        // --- Event Listeners Initialization ---
        function initializeEventListeners() {
            if (!elements) return; console.log("Initializing listeners...");
            elements.bottomNavItems?.forEach(item => item.addEventListener('click', (e) => { e.preventDefault(); showSection(item.dataset.section); }));
            
            elements.homeTabs?.forEach(tab => tab.addEventListener('click', (e) => {
                const targetStatus = e.currentTarget.dataset.target;
                if(targetStatus) {
                    showSection('tournaments-section');
                    const tournamentTab = querySel(`.tournament-tabs .tab-item[data-status="${targetStatus}"]`);
                    if(tournamentTab) tournamentTab.click();
                    
                    if(!currentTournamentGameId) {
                        elements.tournamentsListContainer.innerHTML = `
                            <div class="alert alert-info text-center mt-3">
                                <i class="bi bi-info-circle-fill"></i> Please select a game from the <strong>Home Page</strong> first to see ${targetStatus} tournaments.
                            </div>
                            <div class="d-grid mt-2">
                                <button class="btn btn-sm btn-custom btn-custom-secondary" onclick="document.getElementById('headerBackBtnEl').click()">Go to Games List</button>
                            </div>
                        `;
                    }
                }
            }));

            elements.headerBackBtn?.addEventListener('click', () => showSection('home-section'));
            elements.tournamentTabs?.forEach(tab => tab.addEventListener('click', (e) => { const s = e.currentTarget.dataset.status; if (currentTournamentGameId && s) { elements.tournamentTabs.forEach(t => t.classList.remove('active')); e.currentTarget.classList.add('active'); filterTournaments(currentTournamentGameId, s); } }));
            elements.loginEmailBtn?.addEventListener('click', loginWithEmail);
            elements.signupEmailBtn?.addEventListener('click', signUpWithEmail);
            elements.showSignupToggleBtn?.addEventListener('click', () => toggleLoginForm(false));
            elements.showLoginToggleBtn?.addEventListener('click', () => toggleLoginForm(true));
            elements.forgotPasswordLink?.addEventListener('click', (e) => { e.preventDefault(); resetPassword(); });
            elements.logoutProfileBtn?.addEventListener('click', logoutUser);
            elements.policyLinks?.forEach(link => link.addEventListener('click', handlePolicyClick));
            elements.notificationSwitch?.addEventListener('change', (e) => console.log("Notification toggle:", e.target.checked));
            elements.withdrawBtn?.addEventListener('click', handleWithdrawClick);
            elements.addAmountWalletBtn?.addEventListener('click', handleAddAmountClick);
            elements.submitWithdrawRequestBtn?.addEventListener('click', submitWithdrawRequestHandler);
            elements.notificationBtn?.addEventListener('click', () => { if (elements.notificationsModalInstance) { elements.notificationsModalInstance.show(); setTimeout(markNotificationsAsRead, 1500); } });
            elements.allTransactionsBtn?.addEventListener('click', () => alert('Transaction history page coming soon!'));
            elements.presetAmountsContainer.addEventListener('click', (e) => { if (e.target.classList.contains('preset-amount-btn')) { elements.rechargeAmountInput.value = e.target.dataset.amount; } });
            elements.rechargeNextBtn.addEventListener('click', () => { const e=parseFloat(elements.rechargeAmountInput.value);if(isNaN(e)||e<10||e>1e4)return void alert("Please enter a valid amount between à§³10 and à§³10000.");rechargeState.amount=e,elements.rechargeConfirmAmount.textContent=`à§³${e.toFixed(2)}`,showRechargeStep(2)});
            elements.rechargeProcessBtn.addEventListener('click', () => { const e=querySel('input[name="paymentMethod"]:checked');if(!e)return void alert("Please select a payment method.");rechargeState.method=e.value,elements.rechargeFinalAmount.textContent=`à§³${rechargeState.amount.toFixed(2)}`,elements.rechargeFinalMethod.textContent=rechargeState.method;const t=appSettings.paymentDetails?.[rechargeState.method.toLowerCase()]||{};elements.rechargePaymentNumber.textContent=t.number||"Not Available",t.qrCodeUrl?(elements.rechargeQrCode.src=t.qrCodeUrl,elements.rechargeQrCode.style.display="inline-block"):(elements.rechargeQrCode.style.display="none"),showRechargeStep(3)});
            elements.rechargeBackBtn.addEventListener('click', () => showRechargeStep(2));
            elements.rechargeSubmitBtn.addEventListener('click', submitRechargeRequest);
            elements.confirmJoinBtnEl?.addEventListener('click', processTournamentJoin);

            elements.sendCommentBtn?.addEventListener('click', sendComment);
            elements.liveSupportBtn?.addEventListener('click', openLiveSupportChat);
            elements.sendLiveSupportBtn?.addEventListener('click', sendLiveSupportMessage);
            elements.editProfileNameBtnEl?.addEventListener('click', () => toggleProfileNameEdit(true));
            elements.saveProfileNameBtnEl?.addEventListener('click', saveProfileName);
            elements.contactSupportBtnEl?.addEventListener('click', handleContactSupportClick);
            elements.claimPromoCodeBtnEl?.addEventListener('click', claimPromoCode); // Added listener for promo code

            document.body.addEventListener('click', (event) => { if (event.target.matches('.copy-btn') || event.target.closest('.copy-btn')) { const btn = event.target.closest('.copy-btn'); if (btn.dataset.target) copyToClipboard(btn.dataset.target); } if (event.target.matches('#shareReferralBtn') || event.target.closest('#shareReferralBtn')) { const cel = getElement('referralCodeDisplay'); if (cel) shareReferral(cel.textContent); } });
            console.log("Listeners initialized.");
        }

        // --- App Initialization ---
        document.addEventListener('DOMContentLoaded', () => {
            console.log("DOM Loaded. Init App...");
            if (typeof initializeApp !== 'function' || !auth || !db) {
                console.error("Firebase SDK failed/not ready."); return;
            }
            showLoader(true);
            initializeEventListeners();
            updateGlobalUI(false); 
            loadAppSettings();
            onAuthStateChanged(auth, handleAuthStateChange);

            // Start the time dashboard clock
            setInterval(updateTimeDashboard, 1000);
            updateTimeDashboard();
        });

    </script>

</body>
</html>